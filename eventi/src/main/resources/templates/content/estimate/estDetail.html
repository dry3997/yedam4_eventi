<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
   xmlns:th="http://www.thymeleaf.org"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
   layout:decorate="~{layouts/default_layout}">
<head>
<style>
input[type=text]{
  width: 100%;
  padding: 12px 20px;
  margin: 8px 0;
  display: inline-block;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
}
#estfrm {
  border-radius: 5px;
  background-color: #f2f2f2;
  padding: 20px;
  width: 50%;
  margin: 0 auto;
}
label {
 color: gray;
}
button {
 float: right;
 margin-right: 50px;
}
#propList {
  border: 1px solid black;
  width: 70%;
  height: auto;
  margin: 15px auto;
}
.list {
  font-family: Arial, Helvetica, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

.list td, .list th {
  border: 1px solid #ddd;
  padding: 2px;
}

.list tr:nth-child(even){background-color: #f2f2f2;}

.list tr:hover {background-color: #ddd;}

.list th {
  text-align: left;
  background-color: #b7472A;
  color: white;
}
</style>
</head>
<body>
<div layout:fragment="content">
   <section class="hero-wrap hero-wrap-2",
      style="background-image: url(&quot;images/bg_2.jpg&quot;); background-position: 50% 0%;"
      data-stellar-background-ratio="0.5">
      <div class="overlay"></div>
      <div class="container">
         <div
            class="row no-gutters slider-text align-items-end justify-content-center">
            <div
               class="col-md-9 ftco-animate mb-5 text-center fadeInUp ftco-animated">
               <h2 class="mb-0 bread">견적서 상세페이지</h2>
            </div>
         </div>
      </div>
   </section>
<div id=estfrm>
<h3>견적요청서</h3>
<hr>
<!-- 선택폼 -->
  <form>
    <label for="title" id="title">어떤 행사를 계획중이신가요?</label>
    <input type="text" id="eventType" name="eventType" th:value="${est.eventType}" readonly>
        <label for="title" id="title" >행사 규모는 어느정도이신가요?</label>
    <input type="text" id="pats" name="pats" th:value="${est.pats}" readonly>
        <label for="title" id="title">행사 예정 장소는 어디인가요?</label>
    <input type="text" id="expectedPl" name="expectedPl" th:value="${est.expectedPl}" readonly>
        <label for="title" id="title">행사 날짜를 선택해주세요.</label>
    <input type="text" id="eventDate" name="eventDate" th:value="${est.eventDate}" readonly>
        <label for="title" id="title">행사 시작시간은 언제인가요?</label>
    <input type="text" id="eventTime" name="eventTime" th:value="${est.eventTime}" readonly>
        <label for="title" id="title">행사 예상 소요시간을 선택해주세요.</label>
    <input type="text" id="eventDuration" name="eventDuration" th:value="${est.eventDuration}" readonly>
        <label for="title" id="title">행사 예정지역을 선택해주세요.</label>
    <input type="text" id="expectedLocal" name="expectedLocal" th:value="${est.expectedLocal}" readonly>
        <label for="title" id="title">행사 관련 희망사항을 알려주세요.</label>
    <input type="text" id="wishes" name="wishes" th:value="${est.wishes}" readonly>
  </form>
</div>
<!-- Button trigger modal -->
 <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal" id="prop">제안서 작성</button>
 <!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">제안서 작성</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
       <label for="companyInt" class="col-form-label">업체소개</label>
       <input type="text" class="form-control" id="recipient-name">
       <label for="companyInt" class="col-form-label">물품목록</label>
   		
		<table id="myGdList" class="list">
		<thead>
		<tr>
		<th>물품명</th>
		<th>금액</th>
		<th>개수</th>
		</tr>
		</thead>
		<tbody>
		
		</tbody>
		</table>
       <label for="companyInt" class="col-form-label">기타목록</label>
       <button id="addCol">기타목록추가</button>
       <table id="etcList" class="list">
		<thead>
		<tr>
		<th>명목</th>
		<th>금액</th>
		</tr>
		</thead>
		<tbody>
		<tr>
		<td><input id="title" style="border: 0;"></td>
		<td><input id="price" style="border: 0;"></td>
		</tr>
		</tbody>
		</table>
       <p id="total">총금액 :</p> 
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="insertBtn">등록</button>
      </div>
    </div>
  </div>
</div><!--  end of Modal -->
  <button type="button" class="btn btn-primary" id="deleteBtn">견적서 삭제</button><br>
  <hr>
 <div id="propList" th:each="prop : ${propList}">
	<p th:text="|업체소개 : ${prop.companyInt}|"></p>
	<p th:text="|총금액 : ${prop.totalPrc}원|"></p>
  <input type="hidden" name="eno" value="${prop.eno}">
    <p th:text="|고용회수 : ${count.adoption}|"></p>	
    <p th:text="|후기수 : ${count.review}|"></p>
    <button type="button" id="detailProp">제안서보기</button>
 </div>

 <input type="hidden" name="sessionId"  class="btn btn-primary"th:value="${session.member.userId}">
 <script>
//csrf 설정
var token = $("meta[name='_csrf']").attr("content");
var header = $("meta[name='_csrf_header']").attr("content");

//해당업체의 등록된물품 조회
 $(function() { 
var userId = $('input[name="sessionId"]').val();
var data = {"userId" : userId};
 	$.ajax({
		url: "/myGoodsList",
		method: "POST",
		data: JSON.stringify(data),
		contentType: 'application/json',
		beforeSend : function(xhr)
        {   
			//데이터를 전송하기 전에 헤더에 csrf값을 설정한다
        xhr.setRequestHeader(header, token);
        },
		success: function (data) {
			$.each(data, function(idx, goods){
				var tr = $("<tr />")
				var goodsNm = $("<td />").append(goods.goodsNm);
				var rentalPrc = $("<td class='prc'/>").append(goods.rentalPrc);
				var stock = $("<td class='stock'/>").append(goods.stock);
				tr.append(goodsNm, rentalPrc, stock)
				$('#myGdList>tbody').append(tr);
			})
         },
         error: function () {
				alert("서버 요청 실패");
			}	
	});
});
 //물품값 자동계산
 $('#prop').on("click", function(){;
		$('#total').html("");
	    var goods = $('#myGdList tbody tr'); //물품의 행
	    var etc = $('#etcList tbody tr');
		var goodsSum = 0; //물품합
		var etcSum = 0; //기타합
		var total = 0; //전체합
		for(let i = 0; i < goods.length; i++){
		 	goodsSum += parseInt($('#myGdList tbody tr').eq(i).find('td').eq(1).html())
		 				* $('#myGdList tbody tr').eq(i).find('td').eq(2).html();
		 }
		for(let i = 0; i < etc.length; i++){
			etcSum += parseInt($('#etcList tbody tr').eq(i).find('td').eq(1).html())
		 }
		 $('#total').append(goodsSum);
 })
 
 //기타목록 추가
 $("#addCol").on("click", function() {
	 var tr = $("#etcList>tbody tr")
	 var td = $("<td />").append($("<input style='border: 0;' />"))
	 $('#etcList>tbody').append(tr);
	 
 })
 //견적서 삭제
 $('#deleteBtn').on("click", function(){
     var eno = $('#deleteBtn').val();	 
	 if(!confirm('삭제하시겠습니까?')) {
		 return false;
	 }
	 $.ajax({
		 url:"/deleteEst",
		 method:"POST",
		 data: {eno},
		 beforeSend : function(xhr)
         {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token);
         },
         success: function(data){
        	 if(data == 1){
        		 alert('삭제되었습니다.');
        		 location.href="/estList";
        	 }
         },
          error: function () {
 				alert("서버 요청 실패");
 			}
	 });
 });
 //제안서 등록
 $('#insertBtn').on("click", function(){	 
	 $.ajax({
		 url:"/insert",
		 method:"POST",
		 data: {eno},
		 beforeSend : function(xhr)
         {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token);
         },
         success: function(data){

         },
          error: function () {
 				alert("서버 요청 실패");
 			}
	 });
 });

</script>
</div><!-- End of layout:fragment -->
</body>
</html>