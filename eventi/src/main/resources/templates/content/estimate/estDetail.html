<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
   xmlns:th="http://www.thymeleaf.org"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
   layout:decorate="~{layouts/default_layout}">
<head>
<style>
input[type=text]{
  width: 100%;
  padding: 12px 20px;
  margin: 8px 0;
  display: inline-block;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
}
#estfrm {
  border-radius: 5px;
  background-color: #f2f2f2;
  padding: 20px;
  width: 50%;
  margin: 0 auto;
}
label {
 color: gray;
}
button {
 float: right;
 margin-right: 50px;
}
#propList {
  border: 1px solid black;
  width: 70%;
  height: auto;
  margin: 15px auto;
}
.list {
  font-family: Arial, Helvetica, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

.list td, .list th {
  border: 1px solid #ddd;
  padding: 2px;
}

.list tr:nth-child(even){background-color: #f2f2f2;}

.list tr:hover {background-color: #ddd;}

.list th {
  text-align: left;
  background-color: #b7472A;
  color: white;
}
</style>
</head>
<body>
<div layout:fragment="content">
 <section class="module bg-dark-60 gallery-page-header parallax-bg" data-background="/assets/images/gallery_bg.jpg" style="background-image: url(&quot;assets/images/gallery_bg.jpg&quot;);">
          <div class="container">
            <div class="row">
              <div class="col-sm-6 col-sm-offset-3">
                <h2 class="module-title font-alt">Big Title</h2>
                <div class="module-subtitle font-serif">Small Title</div>
              </div>
            </div>
          </div>
        </section>
<div id=estfrm>
<h3>견적요청서</h3>
<hr>
<!-- 선택폼 -->
  <form>
    <label for="title" id="title">어떤 행사를 계획중이신가요?</label>
    <input type="text" id="eventType" name="eventType" th:value="${est.eventType}" readonly>
        <label for="title" id="title" >행사 규모는 어느정도이신가요?</label>
    <input type="text" id="pats" name="pats" th:value="${est.pats}" readonly>
        <label for="title" id="title">행사 예정 장소는 어디인가요?</label>
    <input type="text" id="expectedPl" name="expectedPl" th:value="${est.expectedPl}" readonly>
        <label for="title" id="title">행사 날짜를 선택해주세요.</label>
    <input type="text" id="eventDate" name="eventDate" th:value="${est.eventDate}" readonly>
        <label for="title" id="title">행사 시작시간은 언제인가요?</label>
    <input type="text" id="eventTime" name="eventTime" th:value="${est.eventTime}" readonly>
        <label for="title" id="title">행사 예상 소요시간을 선택해주세요.</label>
    <input type="text" id="eventDuration" name="eventDuration" th:value="${est.eventDuration}" readonly>
        <label for="title" id="title">행사 예정지역을 선택해주세요.</label>
    <input type="text" id="expectedLocal" name="expectedLocal" th:value="${est.expectedLocal}" readonly>
        <label for="title" id="title">행사 관련 희망사항을 알려주세요.</label>
    <input type="text" id="wishes" name="wishes" th:value="${est.wishes}" readonly>
    <input type="hidden" id="thisEno" th:value="${est.eno}">
  </form>
</div>
<!-- Button trigger modal -->
 <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal" id="prop">제안서 작성</button>
 <!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">제안서 작성</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
       <label for="companyInt" class="col-form-label">업체소개</label>
       <input type="text" class="form-control" id="recipient-name">
       <label for="companyInt" class="col-form-label">물품목록</label>
   		
		<table id="myGdList" class="list">
		<thead>
		<tr>
	    <th><input type="checkbox" id="all_select"></th>	
		<th>물품명</th>
		<th>금액</th>
		<th>개수</th>
		</tr>
		</thead>
		<tbody>
		
		</tbody>
		</table>
       <label for="companyInt" class="col-form-label">기타비용</label>
       <table id="etcList" class="list">
		<thead>
		<tr>
		<th>명목</th>
		<th>금액</th>
		</tr>
		</thead>
		<tbody>
		<tr>
		<td>행사운영비</td>
		<td><input id="price" style="border: 0"></td>
		</tr>
		</tbody>
		</table>
       <p id="total">총금액 :</p> 
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="insertBtn">등록</button>
      </div>
    </div>
  </div>
</div><!--  end of Modal -->

  <button type="button" class="btn btn-primary" id="deleteBtn">견적서 삭제</button><br>
  <hr>
  
<!-- 업체제안서 리스트 -->
 <div id="propList" th:each="prop : ${propList}">
	<p th:text="|업체소개 : ${prop.companyInt}|"></p>
	<p th:text="|업체아이디 : ${prop.userId}|"></p>
	<p th:text="|총금액 : ${prop.totalPrc}원|"></p>
  <input type="hidden" name="pno" id="pno" th:value="${prop.pno}">
    <p th:text="|고용회수 : ${count.adoption}|"></p>	
    <p th:text="|후기수 : ${count.review}|"></p>
     <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal2" id="getProp" th:value="${prop.userId}">제안서 보기</button>
    <button type="button" class="btn btn-primary" id="delProp">제안서 삭제</button>
 <!-- Modal -->
<div class="modal fade" th:id="exampleModal2" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">제안서 보기</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      <div id="companyInt">
       <label for="companyInt" class="col-form-label">업체소개</label>
       </div>
       <label for="gdList" class="col-form-label">물품목록</label>
   		
		<table id="fixedGdList" class="list">
		<thead>
		<tr>	
		<th>물품명</th>
		<th>금액</th>
		<th>개수</th>
		</tr>
		</thead>
		<tbody>
		
		</tbody>
		</table>
       <label for="etcList" class="col-form-label">기타비용</label>
       <table id="fixedEtcList" class="list">
		<thead>
		<tr>
		<th>명목</th>
		<th>금액</th>
		</tr>
		</thead>
		<tbody>
		<tr>
		<td>행사운영비</td>
		<td></td>
		</tr>
		</tbody>
		</table>
       <p id="total"></p> 
      </div>
      <div class="modal-footer">
               <button type="button" class="btn btn-primary" id="chooesProp">채택</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div><!--  end of Modal -->
 </div>
 <input type="hidden" name="sessionId" id="sessionId" th:value="${session.member.userId}">
<script>
//csrf 설정
var token = $("meta[name='_csrf']").attr("content");
var header = $("meta[name='_csrf_header']").attr("content");

//해당업체의 등록된물품 조회
 $(function() {
	 
var userId = $('input[name="sessionId"]').val();
var data = {"userId" : userId};
 	$.ajax({
		url: "/myGoodsList",
		method: "POST",
		data: JSON.stringify(data),
		contentType: 'application/json',
		beforeSend : function(xhr)
        {   
			//데이터를 전송하기 전에 헤더에 csrf값을 설정한다
        xhr.setRequestHeader(header, token);
        },
		success: function (data) {
			$.each(data, function(idx, goods){
				var tr = $("<tr />").append($("<input type=checkbox name=chk>"))
				var goodsNm = $("<td />").append(goods.goodsNm);
				var rentalPrc = $("<td class='prc'/>").append(goods.rentalPrc);
				var stock = $("<td class='stock'/>").append(goods.stock);
				tr.append(goodsNm, rentalPrc, stock)
				$('#myGdList>tbody').append(tr);
			})
         },
         error: function () {
				alert("서버 요청 실패");
			}	
	});
});
 //물품값 자동계산
 $('.modal-body').on("change", function(){
		$('#total').html("");
	    var goods = $('#myGdList tbody tr'); //물품의 행
	    var etc = $('#etcList tbody tr');
		var goodsSum = 0; //물품합
		var etcSum = 0; //기타합
		var total = 0; //전체합
		for(let i = 0; i < goods.length; i++){
		if($('#myGdList tbody tr').eq(i).find('input').is(":checked")) {
		 	goodsSum += parseInt($('#myGdList tbody tr').eq(i).find('td').eq(1).html())
		 			  * parseInt($('#myGdList tbody tr').eq(i).find('td').eq(2).html());
		 }
		}
		 var inputVal = parseInt($('#etcList input').val());
		 console.log(inputVal)
		if(!isNaN(inputVal)){
			etcSum += inputVal;
		}
		total = goodsSum + etcSum;
		 $('#total').append("총금액: "+total+"원");
 });
 
 //제안서버튼 누를시 기존에 작성된 기타목록 제거
 $('#prop').on('click', function() {
	 $('#etcList tbody tr').not(":first").remove(); //첫번쨰 tr빼고 제거
	 $('#etcList tbody input').val("");
	 $('#total').html("총금액: "); //총금액 초기화
	 
 })
 //th체크박스 선택시 전체체크
 $('#all_select').on("click", function() {
	 if($("#all_select").is(":checked")){
		 $("input[name='chk']").prop("checked", true);		 
	 } else {
		 $("input[name='chk']").prop("checked", false);
	 }
	 $("input[name=chk]").click(function() {
			var total = $("input[name=chk]").length;
			var checked = $("input[name=chk]:checked").length;
			
			if(total != checked) {
				$("#all_select").prop("checked", false);
				}
			else{
				$("#all_select").prop("checked", true);
				}
		});
 });
 //견적서 삭제
 $('#deleteBtn').on("click", function(){
     var thisEno = $('#thisEno').val();
     var userId = $('#deleteBtn').val();
     var data = {"eno": thisEno, "userId": userId};
   
	 if(!confirm('삭제하시겠습니까?')) {
		 return false;
	 }
	 $.ajax({
		 url:"/deleteEst",
		 method:"POST",
		 data: JSON.stringify(data),
		 contentType: 'application/json',
		 beforeSend : function(xhr)
         {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token);
         },
         success: function(data){
        	 if(data == 1){
        		 alert('삭제되었습니다.');
        		 location.href="/estList";
        	 }
         },
          error: function () {
 				alert("서버 요청 실패");
 			}
	 });
 });
 //제안서 등록
 $('#insertBtn').on("click", function(){
	 //행사운영비 금액
	 var inputVal = parseInt($('#etcList input').val());
	 if(inputVal == 0){
		 alert('행사운영비를 입력해주세요.')
			$("#etcList input").focus();
		 return false;
	 }
	 
	 var eno = $('#thisEno').val();
	 var userId = $('#sessionId').val();
	 var companyInt = 'test';
	 var eventExps = parseInt(inputVal);
	 var totalPrc = parseInt($('#total').html().substr(5));
	
	 var data = {
			 "eno": eno,
			 "userId": userId,
			 "companyInt": companyInt,
			 "totalPrc": totalPrc,
			 "eventExps": eventExps
	 };
	 console.log(data)
	  $.ajax({
		 url: "/insertProp",
		 method: "POST",
		 contentType: 'application/json',
		 data: JSON.stringify(data),
		 beforeSend : function(xhr)
         {   //데이터를 전송하기 전에 헤더에 csrf값을 설정한다
				xhr.setRequestHeader(header, token);
         },
         success: function(data){
			if(data == 1)
				alert('등록이 완료되었습니다.')
				location.reload(true)				
         },
          error: function () {
 				alert("서버 요청 실패");
 			}
	 });  
 });
 //제안서 상세보기
 $('#getProp').on('click', function() {
	 $('#companyInt').html("");
	 $('#fixedGdList tbody tr').remove();
	 var pno = $('#pno').val();
	 var data = {"pno": pno};
	 $.ajax({
		 url: "/getProp",
		 method: "POST",
		 contentType: 'application/json',
		 data: JSON.stringify(data),
		 beforeSend : function(xhr)
         {   //데이터를 전송하기 전에 헤더에 csrf값을 설정한다
				xhr.setRequestHeader(header, token);
         },
         success: function(res){ 
        	 var companyInt = res.companyInt;
        	$('#companyInt').append(companyInt);
        	//제안서 물품조회
        	console.log(data)
        	$.ajax({
        		url: "/propGdList",
        		method: "POST",
        		data: JSON.stringify(data),
        		contentType: 'application/json',
        		beforeSend : function(xhr)
                {   
        			//데이터를 전송하기 전에 헤더에 csrf값을 설정한다
                xhr.setRequestHeader(header, token);
                },
        		success: function (data) {
        			console.log(data)
        			$.each(data, function(idx, goods){
        				var tr = $("<tr />")
        				var goodsNm = $("<td />").append(goods.goodsNm);
        				var unitPrc = $("<td class='prc'/>").append(goods.unitPrc);
        				var count = $("<td class='stock'/>").append(goods.count);
        				tr.append(goodsNm, unitPrc, count)
        				$('#fixedGdList>tbody').append(tr);
        			})
                 },
                 error: function () {
        				alert("서버 요청 실패");
        			}	
        	});// end of ajax in ajax
        		
        		
        		console.log(res.eventExps)  
         },
          error: function () {
 				alert("서버 요청 실패");
 			}
	 });
 });
 
 //제안서 삭제
 $('#delProp').on('click', function(){
	 if(!confirm('정말 삭제하시겠습니까?')) {
		 return false;
	 }
	 var pno = $('#pno').val();
	 var data = {"pno": pno}
	 $.ajax({
		 url: "/delProp",
		 method: "POST",
		 data: JSON.stringify(data),
		 contentType: 'application/json',
		 beforeSend : function(xhr)
         {   //데이터를 전송하기 전에 헤더에 csrf값을 설정한다
				xhr.setRequestHeader(header, token);
         },
         success: function(data){
        	if(data == 1) {
        		alert('삭제완료되었습니다.')
        		location.href="/estList"
        	}	
         },
          error: function () {
 				alert("서버 요청 실패");
 			}
	 });
 });
 
 //제안서 채택
 $('#chooesProp').on('click', function(){
	 if(!confirm('채택하시겠습니까?')) {
		 return false;
	 }
	 var pno = $('#pno').val();
	 var data = {"pno": pno};
	 console.log(data);
	 $.ajax({
		 url: "/chooesProp",
		 method: "POST",
		 data: JSON.stringify(data),
		 contentType: 'application/json',
		 beforeSend : function(xhr)
         {   //데이터를 전송하기 전에 헤더에 csrf값을 설정한다
				xhr.setRequestHeader(header, token);
         },
         success: function(data){
        	if(data == 1) {
        		alert('채택되었습니다.');
        		location.href="/estList"
        	}	
         },
          error: function () {
 				alert("서버 요청 실패");
 			}
	 });
 })
</script>
</div><!-- End of layout:fragment -->
</body>
</html>