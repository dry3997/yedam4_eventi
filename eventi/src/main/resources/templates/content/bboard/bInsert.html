<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default_layout}">

<head>
	<style>
		.fileDown{
			display : none;
		}
	</style>
	
	<!-- csrf 설정 -->
	<meta name="_csrf" th:content="${_csrf.token}"/>
	<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<div layout:fragment="content">
	<section class="hero-wrap hero-wrap-2"
		style="background-image: url(&quot;/images/bg_2.jpg&quot;); background-position: 50% 0%;"
		data-stellar-background-ratio="0.5">
		<div class="overlay"></div>
		<div class="container">
			<div
				class="row no-gutters slider-text align-items-end justify-content-center">
				<div
					class="col-md-9 ftco-animate mb-5 text-center fadeInUp ftco-animated">
					<!-- 게시글 유형별 if문을 통해 처리 -->
					<th:block th:if="${type =='T04'}">
						<h2 class="mb-0 bread">자유게시글 등록</h2>
					</th:block>
					<th:block th:if="${type =='T05'}">
						<h2 class="mb-0 bread">멘토링게시글 등록</h2>
					</th:block>
				</div>
			</div>
		</div>
	</section>

	<div class="row no-gutters">
		<div class="col-md-7">
			<div class="contact-wrap w-100 p-md-5 p-4">
				<!-- 게시글 유형별 if문을 통해 처리 -->
				<th:block th:if="${type =='T04'}">
					<h3 class="mb-4">자유게시판 글쓰기</h3>
				</th:block>
				<th:block th:if="${type =='T05'}">
					<h3 class="mb-4">멘토링게시판 글쓰기</h3>
				</th:block>
				<form action="/bboard/bInsert" method="POST" id="bBoardForm" name="bBoardForm" class="contactForm" enctype="multipart/form-data">
					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
					<input type="text" id="bBoardNo" name="bBoardNo" th:value="${nextNo}">
					<input type="button" id="saveFile" value="불러오기" class="btn btn-primary">
					<div class="row">
						<div class="col-md-12">
							<div class="form-group">
								<input type="hidden" name="type" id ="type" th:value="${type}">
								<label class="label" for="name">제목</label>
								<input type="text" class="form-control" name="ttl" id="ttl" placeholder="제목">
							</div>
						</div>
						
						<div class="col-md-12">
							<div class="form-group">
								<label class="label" for="email">작성자</label> 
								<input type="checkbox" name="secri" value="secri">익명 
								<input type="text" class="form-control" name="writer" id="writer" th:value="${session.member.userId}" readonly>
							</div>
						</div>
						
						<!-- 게시글 유형별 if문을 통해 처리 -->
						<th:block th:if="${type =='T04'}">
							<div class="col-md-12">
								<div class="form-group">
									<label class="label" for="lclsf">분류</label> 
									<input type="radio" name="lclsf"  value="genrl" checked>일반 
									<input type="radio" name="lclsf" value="reply">후기
								</div>
							</div>
						</th:block>
			`			
						<th:block th:if="${type == 'T05'}">
						<div class="col-md-12">
							<div class="form-group">
								<label class="label" for="lclsf">직업</label> 
								<input type="radio" name="lclsf" value="mc" checked="checked">사회자 
								<input type="radio" name="lclsf" value="dgner">디자이너
							</div>
						</div>
						
						<div class="col-md-12">
							<div class="form-group">
								<label class="label" for="mclsf">질문</label> 
								<select id="mclsf" name="mclsf">
									<option value="">질문내용을 선택해 주세요.</option>
									<option value="계약">계약</option>
									<option value="진행">진행</option>
									<option value="기타">기타</option>
								</select>
							</div>
						</div>
						</th:block>

						<div class="col-md-12">
							<div class="form-group">
								<label class="label" for="#">내용</label>
								<textarea name="cntn" class="form-control" id="cntn" cols="30" rows="4"></textarea>
							</div>
						</div>

						<div class="col-md-12">
							<div class="form-group">
								<input type="file" id="imgInp" name="uploadFile" multiple="multiple"/>
								<div class="fileDown">
									<img id="blah" src="#" alt = "your image" width="250px" />
									<button type="button" id="cancel" class="btn btn-warning cancel">
						              <span>Cancel</span>
						          	</button>
								</div>
							</div>
						</div>

						<div class="col-md-12">
							<div class="form-group">
								<input type="submit" id="insert" value="등록" class="btn btn-primary">
								<input type="checkbox" id="save" name="save" th:value="N" class="btn btn-primary">임시저장
								<div class="submitting"></div>
							</div>
						</div>						
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
		//csrf 설정
    	var token = $("meta[name='_csrf']").attr("content");
		var header = $("meta[name='_csrf_header']").attr("content");
		
		//네이버스마트에디터 실행
		let oEditors = []

		smartEditor = function() {
			console.log("Naver SmartEditor")
			nhn.husky.EZCreator.createInIFrame({
				oAppRef : oEditors,
				elPlaceHolder : "cntn", //적용하고자하는 textarae태그 영역과 동일한 id 이름 입력
				sSkinURI : "/smarteditor2/SmartEditor2Skin.html",
				fCreator : "createSEditor2"
			})
		}
		
		$(document).ready(function() {
			smartEditor()
		})
	     
	    //파일 업로드 이미지 미리보기
	    //파일 INPUT창에 변화가 있을 경우 실행
	    $("#imgInp").on('change', function() {
	    	//파일을 올렸을 경우 input type=file은 사라지고 이미지만 띄어진다.
	    	$(this).toggleClass("fileDown");
	    	$(this).next().toggleClass("fileDown");
			readURL(this);
		});
		
	    //이미지 미리보기 처리
		function readURL(input){
			if(input.files && input.files[0]){
				var reader = new FileReader();
				reader.onload = function(e) {
					$("#blah").attr('src', e.target.result);
				}
				reader.readAsDataURL(input.files[0]);
			}
		}
	    
	    //파일 삭제
	    $("#cancel").on('click', function() {
	    	//파일을 지우고 싶을때 삭제버튼을 누르면 이미지는 사라지고 input type=file 입력폼이 다시 나타난다.
	    	$(this).parent().prev().toggleClass("fileDown");
	    	$(this).parent().toggleClass("fileDown");
	    	//file영역에 있던 값 삭제
	    	$("#imgInp").val('');
	    })
	    
	    //임시저장 체크박스를 클릭했을 경우
	    $('#save').click(function(){
	    	if($('#save').is(':checked')){
				$('#save').val('Y');
			};
	    })
	    
		//등록버튼을 눌렀을 경우 아래와 설정을 해주지 않을 경우 태그 속성이 저장되지 않는다.
		$('#insert').on('click', function insert() {
			oEditors.getById["cntn"].exec("UPDATE_CONTENTS_FIELD", [])
			let cntn = document.getElementById("cntn").value
		})
		
		//불러오기
		 $('#saveFile').on('click', function() {
			let userId = '[[${session.member.userId}]]';
			
			//게시글 불러오기
			$.ajax({
				url : "/bboard/bSave",
				method : 'post',
				data : JSON.stringify({writer:userId, save:'Y'}),
	   			contentType : "application/json",
	   			beforeSend : function(xhr)
	            {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
					xhr.setRequestHeader(header, token);
	            },
				success : function(data) {
					console.log(data);
					//임시저장된 게시글이 없을 경우
					if(data == 0){
						alert('임시저장된 게시글이 없습니다.');
					} else { //임시저장된 게시글이 있을 경우
						$("#bBoardNo").val(data.bboardNo);
						$("#ttl").val(data.ttl);
						$("input:radio[name='lclsf']:radio[value='"+data.lclsf+"']").attr('checked', true);
						
						if(data.mclsf != null){
							$("#mclsf").val(data.mclsf).attr("selected", true);
						}
						
						oEditors.getById["cntn"].exec("PASTE_HTML", [data.cntn]);
						
						$("#bBoardForm").attr("action", "/bboard/bUpdate");
					}
				},
				fail : function(result) {
					alert('필수항목을 입력해주세요')
				}
			})
		})
	</script>
</div>
</html>