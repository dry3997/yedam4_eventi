<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
   xmlns:th="http://www.thymeleaf.org"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
   layout:decorate="~{layouts/default_layout}">

<head>
<style>
.heart {
  width: 100px;
  height: 100px;
  background: url("https://cssanimation.rocks/images/posts/steps/heart.png") no-repeat;
  background-position: 0 0;
  cursor: pointer;
  transition: background-position 1s steps(28);
  transition-duration: 0s;
  }
  
  .active {
    transition-duration: 1s;
    background-position: -2800px 0;
  }
</style>

<!-- csrf 설정 -->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<div layout:fragment="content">
   <section class="hero-wrap hero-wrap-2"
      style="background-image: url(&quot;/images/bg_2.jpg&quot;); background-position: 50% 0%;"
      data-stellar-background-ratio="0.5">
      <div class="overlay"></div>
      <div class="container">
         <div
            class="row no-gutters slider-text align-items-end justify-content-center">
            <div
               class="col-md-9 ftco-animate mb-5 text-center fadeInUp ftco-animated">
               <h2 class="mb-0 bread">게시글</h2>
            </div>
         </div>
      </div>
   </section>
   
   <!-- 현재 로그인된 id와 작성자id가 동일할 경우 버튼 나타남 -->
   <th:block th:if="${session.member.userId} == ${bSelect.writer}">
   <button type="button" class="btn btn-primary" th:onclick="|location.href='@{bUpdate(bBoardNo=${bSelect.bBoardNo})}'|">글 수정하기</button>
   <button type="button" class="btn btn-primary" th:onclick="|location.href='@{bDelete(bBoardNo=${bSelect.bBoardNo}, type=${bSelect.type})}'|">글 삭제하기</button>
   </th:block>
   
   <th:block th:if="${like == null}">
   	<div class="stage">
  		<div class="stage heart"></div>
  		<span id="likeCount" th:text="${likeCount}"></span>
   	</div>
   </th:block>
   
   <th:block th:if="${like != null}">
   	<div class="stage">
  		<div class="stage heart active"></div>
  		<span id="likeCount" th:text="${likeCount}"></span>
   	</div>
   </th:block>
   
   <table class="table mb-3">
      <thead class="thead-dark">
         <tr>
            <th>게시판번호</th>   
            <th>작성자</th>   
            <th>제목</th>
            <th>내용</th>
            <th>조회수</th>
            <th>작성일자</th>
            <th>타입</th>   
         </tr>
      </thead>
      <tbody>
         <tr>
            <td id="bBoardNo" th:text=${bSelect.bBoardNo}></td>
            <td th:text=${bSelect.writer}></td>
            <td th:text=${bSelect.ttl}></td>
            <td th:utext=${bSelect.cntn}></td>
            <td th:text=${bSelect.inq}></td>
            <td th:text="${#dates.format(bSelect.dt, 'yyyy/MM/dd')}"></td>
            <td id = "type" th:text=${bSelect.type}></td>
         </tr>
      </tbody>
   </table>
   			
	<div th:each="f : ${file}">
       <a th:href="|/fileView/${f.sevNm}|" class="image-popup prod-img-bg">
       <img th:src="|/fileView/${f.sevNm}|" style="width: 250px; height: 250px" class="img-fluid" alt="Colorlib Template"></a>
   </div>

   <div>
    	<div class="pt-5 mt-5" >
          <h3 class="mb-5">댓글</h3>
            	<ul class="comment-list" id=reply>
           		</ul>
        </div>
    </div>
        
    <form id="replyInsertFrm">
    	<textarea name="replyCntn" id="replyCntn" cols="30" rows="4" placeholder="댓글을 입력하세요."></textarea>
    	<button type="button" id="repInsertBtn">댓글추가</button>
    </form>
   
   <script>
   $(function() {
	    //csrf 설정
	    var token = $("meta[name='_csrf']").attr("content");
		var header = $("meta[name='_csrf_header']").attr("content");
		
		let userId = '[[${session.member.userId}]]';
		let boardCat = $("#type").text();
		let replyTgt = $("#bBoardNo").text();
		
		$.ajax({
   			url : '/replyList',
   			method : 'post',
   			data : JSON.stringify({boardCat:boardCat, replyTgt:replyTgt}),
   			contentType : "application/json",
   			beforeSend : function(xhr)
            {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token);
            }
   		}).then(res => {
   			for(reply of res){
   				//댓글일 경우
   				if(reply.rerepTgt == null){
   					$("#reply").append(make(reply));
   				} else { //대댓글일 경우, 대댓글의 경우 rerepTgt컬럼에 대댓글을 단 댓글 번호가 적혀있다.
   					//대댓글은 연관있는 댓글 바로 밑에 들어가야되기 때문에 댓글 생성시 id를 부여하여 rerepTgt이 댓글ID와 같은 번호가 적힌 댓글 밑으로 append한다.
   					$("#" + reply.rerepTgt).append(makeRe(reply));
   				}
   			}
   		})
		
   	//댓글 tr생성
   		function make(reply){
   			let p = `
                  <li class="comment">
                    <div class="comment-body"  id="${reply.replyNo}">
                      <h3>${reply.userId}</h3>
                      <div class="meta">${reply.writingDt}</div>
                      <p>${reply.replyCntn}</p>
                      <p><a href="#" class="reply">Reply</a></p>
                    </div>
                   </li>
                `
   			return p;
   		}
   		
   		//대댓글 tr생성
   		function makeRe(reply){
   			//한 댓글당 대댓글은 한개만 달수 있기 때문에 댓글에 있는 reply 버튼 삭제
   			$("#" + reply.rerepTgt).children('p:eq(1)').remove();
   			
   			let p = `<ul class="children">
                <li class="comment">
                <div class="comment-body">
                  <h3>${reply.userId}</h3>
                  <div class="meta">${reply.writingDt}</div>
                  <p>${reply.replyCntn}</p>
                  <p><a href="#" class="reply">Reply</a></p>
                </div>
              </li>
            </ul>`
            
            return p;
   		}

		//댓글 추가
		$("#repInsertBtn").on("click", function() {
			
		})
		
	   //좋아요를 눌렀을 경우
	   $(".heart").on("click", function() {
		 //클래스가 없을 경우 생성, 클래스가 있을 경우 삭제
	     $(this).toggleClass("active");
	     let userId = '사용자1';
	     let targetNo = $("#bBoardNo").text();
	     let category = $("#type").text();
	     
	     //좋아요를 추가했을 경우
	     if($(this).hasClass("active")){
	    	 //총 좋아요수 처리
	    	 let likeCount = $('#likeCount').text();
	    	 $('#likeCount').text(parseInt(likeCount) + 1);
	    	 
	    	 //post방식으로 좋아요 등록하기
	    	 $.ajax({
					url : "/likes/lInsert",
					method : 'post',
					contentType : 'application/x-www-form-urlencoded',
					data : {userId, targetNo, category},
					beforeSend : function(xhr)
	                {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
	    				xhr.setRequestHeader(header, token);
	                },
					success : function(data) {
						//alert('좋아요 등록 완료');
					},
					fail : function(result) {
						alert('필수항목을 입력해주세요')
					}
				})
	     } else if (!$(this).hasClass("active")){ //좋아요를 취소했을 경우
	    	 //총 좋아요수 처리
	    	 let likeCount = $('#likeCount').text();
	    	 $('#likeCount').text(parseInt(likeCount) - 1);
	    	 
	    	//post방식으로 좋아요 취소하기
	    	 $.ajax({
					url : "/likes/lDelete",
					method : 'post',
					contentType : 'application/x-www-form-urlencoded',
					data : {userId, targetNo},
					beforeSend : function(xhr)
	                {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
	    				xhr.setRequestHeader(header, token);
	                },
					success : function(data) {
						//alert('좋아요 취소 완료');
					},
					fail : function(result) {
						alert('필수항목을 입력해주세요')
					}
				})
	     }
	   });
	 });
   </script>
</div>

</html>