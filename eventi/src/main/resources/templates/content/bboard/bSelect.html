<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
   xmlns:th="http://www.thymeleaf.org"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
   layout:decorate="~{layouts/default_layout}">

<head>
<style>
.heart {
  width: 100px;
  height: 100px;
  background: url("https://cssanimation.rocks/images/posts/steps/heart.png") no-repeat;
  background-position: 0 0;
  cursor: pointer;
  transition: background-position 1s steps(28);
  transition-duration: 0s;
  }
  
  .active {
    transition-duration: 1s;
    background-position: -2800px 0;
  }
</style>

<!-- csrf 설정 -->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<div layout:fragment="content">
   <section class="hero-wrap hero-wrap-2"
      style="background-image: url(&quot;/images/bg_2.jpg&quot;); background-position: 50% 0%;"
      data-stellar-background-ratio="0.5">
      <div class="overlay"></div>
      <div class="container">
         <div
            class="row no-gutters slider-text align-items-end justify-content-center">
            <div
               class="col-md-9 ftco-animate mb-5 text-center fadeInUp ftco-animated">
               <h2 class="mb-0 bread">게시글</h2>
            </div>
         </div>
      </div>
   </section>
   <button type="button" class="btn btn-primary" th:onclick="|location.href='@{bUpdate(bBoardNo=${bSelect.bBoardNo})}'|">글 수정하기</button>
   <button type="button" class="btn btn-primary" th:onclick="|location.href='@{bDelete(bBoardNo=${bSelect.bBoardNo}, type=${bSelect.type})}'|">글 삭제하기</button>
   
   <th:block th:if="${like == null}">
   	<div class="stage">
  		<div class="stage heart"></div>
  		<span id="likeCount" th:text="${likeCount}"></span>
   	</div>
   </th:block>
   
   <th:block th:if="${like != null}">
   	<div class="stage">
  		<div class="stage heart active"></div>
  		<span id="likeCount" th:text="${likeCount}"></span>
   	</div>
   </th:block>
   
   <table class="table mb-3">
      <thead class="thead-dark">
         <tr>
            <th>게시판번호</th>   
            <th>작성자</th>   
            <th>제목</th>
            <th>내용</th>
            <th>조회수</th>
            <th>작성일자</th>
            <th>타입</th>   
         </tr>
      </thead>
      <tbody>
         <tr>
            <td id="bBoardNo" th:text=${bSelect.bBoardNo}></td>
            <td th:text=${bSelect.writer}></td>
            <td th:text=${bSelect.ttl}></td>
            <td th:utext=${bSelect.cntn}></td>
            <td th:text=${bSelect.inq}></td>
            <td th:text="${#dates.format(bSelect.dt, 'yyyy/MM/dd')}"></td>
            <td id = "type" th:text=${bSelect.type}></td>
         </tr>
      </tbody>
   </table>
   
   <script>
   $(function() {
	    //csrf 설정
	    var token = $("meta[name='_csrf']").attr("content");
		var header = $("meta[name='_csrf_header']").attr("content");
	   
	   //좋아요를 눌렀을 경우
	   $(".heart").on("click", function() {
		 //클래스가 없을 경우 생성, 클래스가 있을 경우 삭제
	     $(this).toggleClass("active");
	     let userId = '사용자1';
	     let targetNo = $("#bBoardNo").text();
	     let category = $("#type").text();
	     
	     //좋아요를 추가했을 경우
	     if($(this).hasClass("active")){
	    	 //총 좋아요수 처리
	    	 let likeCount = $('#likeCount').text();
	    	 $('#likeCount').text(parseInt(likeCount) + 1);
	    	 
	    	 //post방식으로 좋아요 등록하기
	    	 $.ajax({
					url : "/likes/lInsert",
					method : 'post',
					contentType : 'application/x-www-form-urlencoded',
					data : {userId, targetNo, category},
					beforeSend : function(xhr)
	                {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
	    				xhr.setRequestHeader(header, token);
	                },
					success : function(data) {
						//alert('좋아요 등록 완료');
					},
					fail : function(result) {
						alert('필수항목을 입력해주세요')
					}
				})
	     } else if (!$(this).hasClass("active")){ //좋아요를 취소했을 경우
	    	 //총 좋아요수 처리
	    	 let likeCount = $('#likeCount').text();
	    	 $('#likeCount').text(parseInt(likeCount) - 1);
	    	 
	    	//post방식으로 좋아요 취소하기
	    	 $.ajax({
					url : "/likes/lDelete",
					method : 'post',
					contentType : 'application/x-www-form-urlencoded',
					data : {userId, targetNo},
					beforeSend : function(xhr)
	                {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
	    				xhr.setRequestHeader(header, token);
	                },
					success : function(data) {
						//alert('좋아요 취소 완료');
					},
					fail : function(result) {
						alert('필수항목을 입력해주세요')
					}
				})
	     }
	   });
	 });
   </script>
</div>

</html>