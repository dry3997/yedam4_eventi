<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
   xmlns:th="http://www.thymeleaf.org"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
   layout:decorate="~{layouts/default_layout}">

<head>
<style>
.heart {
  width: 100px;
  height: 100px;
  background: url("https://cssanimation.rocks/images/posts/steps/heart.png") no-repeat;
  background-position: 0 0;
  cursor: pointer;
  transition: background-position 1s steps(28);
  transition-duration: 0s;
  }
  
  .active {
    transition-duration: 1s;
    background-position: -2800px 0;
  }
</style>

<!-- csrf 설정 -->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<div layout:fragment="content">
   <section class="hero-wrap hero-wrap-2"
      style="background-image: url(&quot;/images/bg_2.jpg&quot;); background-position: 50% 0%;"
      data-stellar-background-ratio="0.5">
      <div class="overlay"></div>
      <div class="container">
         <div
            class="row no-gutters slider-text align-items-end justify-content-center">
            <div
               class="col-md-9 ftco-animate mb-5 text-center fadeInUp ftco-animated">
               <h2 class="mb-0 bread">자유 게시판</h2>
            </div>
         </div>
      </div>
   </section>
   	
   	<button type="button" class="btn btn-primary" th:onclick="|location.href='@{bInsert(type=${type})}'|">글 등록하기</button>
   	
   	<!-- 라디오 버튼 게시글별 정렬 -->
   	<th:block th:if="${type =='T04'}">
		<input type="radio" name="lclsf" value="all" checked>전체
   		<input type="radio" name="lclsf" value="genrl">일반
   		<input type="radio" name="lclsf" value="reply">후기
	</th:block>
	<th:block th:if="${type =='T05'}">
		<input type="radio" name="lclsf" value="all" checked>전체
   		<input type="radio" name="lclsf" value="mc">사회자
   		<input type="radio" name="lclsf" value="dgner">디자이너
	</th:block>
   	
   	<!-- option 게시글별 조회수, 작성일순 정렬기준 -->
	<select id="order" name="order">
		<option value="dt" selected>작성일순</option>
		<option value="inq">조회순</option>
		<option value="cnt">좋아요순</option>
	</select>
	
	<!-- 게시글 검색 -->
	<input type="text" name="search">
	<input type="button" id="find" value="찾기"><span></span></input>
   	
   	<div class="stage">
  		<div id="love" class="stage heart"></div>
   	</div>
   	
    <table class="table mb-3">
	      <thead class="thead-dark">
	         <tr>
	            <th>게시판번호</th>
	            <th>분류</th>   
	            <th>작성자</th>   
	            <th>제목</th>
	            <th>조회수</th>
	            <th>작성일자</th>
	            <th>타입</th>
	            <th>좋아요수</th>   
	         </tr>
	      </thead>
	      <tbody id = "check">
	         <tr th:each="b : ${bList}" th:onclick="|location.href='@{bSelect(bBoardNo=${b.bBoardNo})}'|">
	            <td th:text=${b.bBoardNo}></td>
	            <!-- 대분류별 if문 처리 -->
	            <td th:if="${b.lclsf} == 'genrl'" th:text="일반"></td>
	            <td th:if="${b.lclsf} == 'reply'" th:text="후기"></td>
	            <td th:if="${b.lclsf} == 'mc'" th:text="사회자"></td>
	            <td th:if="${b.lclsf} == 'dgner'" th:text="디자이너"></td>
	            <td th:text=${b.writer}></td>
	            <td th:text=${b.ttl}></td>
	            <td th:text=${b.inq}></td>
	            <td th:text="${#dates.format(b.dt, 'yyyy/MM/dd')}"></td>
	            <td id = type th:text=${b.type}></td>
	            <td th:text=${b.cnt}></td>
	         </tr>
	      </tbody>
	   </table>
   
   <script>
    //csrf 설정
    var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
   		//라디오 버튼 정렬 클릭시
   		$("input:radio[name=lclsf]").click(function(){
   			//좋아요 눌려져 있을 경우 active 클래스 삭제
   			$("#love").removeClass('active');
   			//정렬 리스트 불러오는 함수 실행
   			range();
   		})
   		
   		//옵션 정렬 클릭시
   		$('#order').change(function() {
   			if($("#love").hasClass("active")) { //하트가 눌려졌을 때
   				heart();
   			} else if(!$("#love").hasClass("active")){ //하트가 눌리지 않았을 때
   				range();
   			}
   		});
   		
   		//검색 기능
   		$('#find').click(function() {
   			//입력한 값 가져오기
   			let search = $("input[name=search]").val();
   			let type = $("#type").text();
   			
   			//post방식으로 리스트 불러오기
			$.ajax({
				url : '/bboard/bList',
				method : 'post',
				data : {type:type},
				beforeSend : function(xhr)
                {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
    				xhr.setRequestHeader(header, token);
                }
			}).then(res => {
				//tbody밑에 있는 데이터 지우기
				$("#check").empty();
				
				//tbody에 들어갈 tr 생성
				for(r of res){
					if(r.ttl.includes(search) || r.cntn.includes(search)){
						$("#check").append(makeTr(r));
		   			}
				}
			})
			$("input[name=search]").val('');
   		})
   		
   		//정렬 리스트 불러오는 함수
   		function range() {
   				//정렬 기준
				let lclsf = $("input[name=lclsf]:checked").val();
				let type = $("#type").text();
				let order = $("#order option:selected").val();
				
				//post방식으로 리스트 불러오기
				$.ajax({
					url : '/bboard/bList',
					method : 'post',
					data : {lclsf:lclsf, type:type, order:order},
					beforeSend : function(xhr)
	                {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
	    				xhr.setRequestHeader(header, token);
	                }
				}).then(res => {
					//tbody밑에 있는 데이터 지우기
					$("#check").empty();
					
					//tbody에 들어갈 tr 생성
					for(r of res){
						$("#check").append(makeTr(r));
					}
				})
   		}
   		
   		//tr 생성 함수
   		function makeTr(r){
   			//대분류별로 들어가는 값이 다르기때문에 미리 처리 후 td에 등록
   			let lclsf = `${r.lclsf}`;
   			if(lclsf === "genrl"){
   				lclsf = '일반';
   			} else if(lclsf === "reply"){
   				lclsf = '후기';
   			} else if(lclsf === "mc"){
   				lclsf = '사회자';
   			} else if(lclsf === "dgner"){
   				lclsf = '디자이너';
   			}
   			
	   		let tr = ` <tr onclick="location.href='/bboard/bSelect?bBoardNo=${r.bboardNo}'">
				   			<td>${r.bboardNo}</td>
				   			<td>` + lclsf + `</td>
				   			<td>${r.writer}</td>
			   		        <td>${r.ttl}</td>
			   		        <td>${r.inq}</td>
			   		        <td>${r.dt}</td>
			   		        <td id = type>${r.type}</td>
			   		     	<td>${r.cnt}</td>
					    </tr>`
		         
		    return tr;
	   	}
   		
   	   //하트를 클릭했을 경우 발생하는 이벤트
  	   $(".heart").on("click", function() {
  		 //active 클래스가 없을 경우 생성, 있을 경우 삭제
  	     $(this).toggleClass("active");
  		 //하트 기준으로 리스트 정렬 함수
  	     heart();
  	 	});
  	   
   	   //하트 기준으로 리스트 정렬
  	   function heart(){
   		 //정렬 기준
   		 //로그인 된 아이디 집어넣을 예정
  		 let userId = '사용자1'; 
	     let type = $("#type").text();
	     let order = $("#order option:selected").val();
	     
	     if($("#love").hasClass("active")){ //하트가 눌렸을 경우 실행
	    	 $("input:radio[name='lclsf']:radio[value='all']").prop('checked', true); // 전체 라디오 버튼선택하기
	    	 $.ajax({
					url : '/bboard/bList',
					method : 'post',
					data : {writer:userId, type:type, order:order},
					beforeSend : function(xhr)
	                {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
	    				xhr.setRequestHeader(header, token);
	                }
				}).then(res => {
					//tbody밑에 있는 데이터 지우기
					$("#check").empty();
					
					//tbody에 들어갈 tr 생성
					for(r of res){
						$("#check").append(makeTr(r));
					}
				})
	     } else if (!$("#love").hasClass("active")){ //하트가 눌리지 않았을 경우 실행
	    	 $("input:radio[name='lclsf']:radio[value='all']").prop('checked', true); // 전체 라디오 버튼선택하기
	    	 //정렬 리스트 불러오는 함수
	    	 range();
	     }
  	   }
   </script>
</div>
</html>