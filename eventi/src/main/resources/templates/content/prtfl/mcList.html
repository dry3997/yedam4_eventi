<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default_layout}"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
<style>
.heart {
  width: 100px;
  height: 100px;
  background: url("https://cssanimation.rocks/images/posts/steps/heart.png") no-repeat;
  background-position: 0 0;
  cursor: pointer;
  transition: background-position 1s steps(28);
  transition-duration: 0s;
  }
  
  .module .heart{
  	  position: absolute;
	  top : -15px;
	  left : 290px;
  }
  
  .active {
    transition-duration: 1s;
    background-position: -2800px 0;
  }
</style>
</head>

<div layout:fragment="content">
   <section class="module bg-dark-60 gallery-page-header parallax-bg" data-background="/assets/images/gallery_bg.jpg" style="background-image: url(&quot;assets/images/gallery_bg.jpg&quot;);">
     <div class="container">
       <div class="row">
         <div class="col-sm-6 col-sm-offset-3">
           <h2 class="module-title font-alt">사회자포트폴리오</h2>
           <div class="module-subtitle font-serif">사회자포트폴리오</div>
         </div>
       </div>
     </div>
   </section>
   
   <!-- 포트폴리오 등록 -->
   <button type="button" class="btn btn-primary" th:onclick="checkPrtfl()">나의 포트폴리오</button>
   
   <!-- 정렬순 -->
   <select id="order" name="order">
   		<option value="">==========</option>
		<option value="dt" th:selected="${mcPrtflVO.order=='dt'}">작성일순</option>
		<option value="inq" th:selected="${mcPrtflVO.order=='inq'}">조회순</option>
		<option value="cnt" th:selected="${mcPrtflVO.order=='cnt'}">좋아요순</option>
	</select>
	
	<!-- 비회원 좋아요버튼-->
	<th:block sec:authorize="!isAuthenticated()">
		<div class="stage">
			<div id="logOut" class="stage heart" th:onclick="|location.href='@{/loginPage}'|"></div>
		</div>
	</th:block>
	
	<!-- 회원 좋아요버튼-->
	<th:block sec:authorize="isAuthenticated()">
		<div class="stage">
	  		<div id="love" class="love stage heart" th:classappend="${param.userId} !=null ? active"></div>
	   	</div>
   	</th:block>
   
   <section class="module">
	 <div class="container">
   		<div class="row multi-columns-row post-columns">
	        <div class="col-sm-6 col-md-4 col-lg-4" th:each="mc : ${mcList}">
	          <div class="post">

	            <div class="post-thumbnail"><a th:href="|/prtfl/mcSelect?userId=${mc.userId}|">
	            <img th:src="|/fileView/${mc.img}|" alt="Blog-post Thumbnail"></a>
	            </div>

	            <div class="post-header font-alt">
	              <h2 class="post-title" th:text=${mc.userId}><a href="#"></a></h2>
	              <th:block sec:authorize="!isAuthenticated()">
						<div class="stage">
							<div class="stage heart" th:onclick="|location.href='@{/loginPage}'|"></div>
						</div>
				   </th:block>
				   
				   <!-- 회원 좋아요버튼-->
					<th:block sec:authorize="isAuthenticated()">
						<div class="stage">
					  		<div class="love stage heart" th:id="${mc.userId}" th:classappend="${mc.userLike} == 1 ? active"></div>
					   	</div>
				   	</th:block>
	              <div class="post-meta"><a th:href="|/prtfl/mcSelect?userId=${mc.userId}|" th:text="${mc.carrYear} + '년 &nbsp;| ' + ${mc.mcArea} +' | 좋아요 ' + ${mc.cnt} + '건 | 조회수 ' + ${mc.inq}"></a>
	              </div>
	            </div>
	            <div class="post-entry">
	              <p th:text=${mc.oneIntro}></p>
	            </div>
	            <div class="post-more"><a class="more-link" th:href="|/prtfl/mcSelect?userId=${mc.userId}|">Read more</a></div>
	          </div>
	        </div>   
		</div>
		
      </div>
    </section>

   <!-- 페이징 처리 -->
		<div class="row mt-5">
          <div class="col text-center">
            <div class="block-27">
               <th:block th:replace="fragments/paging :: component(${paging},'gopage')">
            </div>
          </div>
        </div>
	
	<script>
		var token = $("meta[name='_csrf']").attr("content");
		var header = $("meta[name='_csrf_header']").attr("content");
		
		//페이징 처리
		function gopage(i) {
			location.href='/prtfl/mcList?page=' + i;
		}
		
		//나의 포트폴리오 확인
		function checkPrtfl(){
			let userId = '[[${session.member != null ? session.member.userId :''}]]';
			$.ajax({
				url : "/prtfl/checkMc",
				method : 'post',
				contentType : 'application/x-www-form-urlencoded',
				data : {userId:userId},
				beforeSend : function(xhr)
                {
    				xhr.setRequestHeader(header, token);
                },
				success : function(data) {
					if(data<1){
						if(confirm('등록된 포트폴리오가 없습니다. 등록하시겠습니까?')){
							location.href='/prtfl/mcInsert';
						}
					} else {
						location.href='/prtfl/mcSelect?userId=' + userId;
						}
				},
				fail : function(result) {
					alert('필수항목을 입력해주세요')
				}
			})
		}
		
		
		//좋아요 처리
		 $(".love").on("click", function() {
			 $(this).toggleClass("active");
			 let userId = '[[${session.member != null ? session.member.userId :''}]]';
			 let targetNo = $(this).attr('id');
			 let category = 'T06';
			 
			 //좋아요를 추가했을 경우
		     if($(this).hasClass("active")){
		    	 //총 좋아요수 처리
		    	 let likeCount = $('#likeCount').text();
		    	 $('#likeCount').text(parseInt(likeCount) + 1);
		    	 
		    	 //post방식으로 좋아요 등록하기
		    	 $.ajax({
						url : "/likes/lInsert",
						method : 'post',
						contentType : 'application/x-www-form-urlencoded',
						data : {userId:userId, targetNo:targetNo, category:category},
						beforeSend : function(xhr)
		                {  
		    				xhr.setRequestHeader(header, token);
		                },
						success : function(data) {
						},
						fail : function(result) {
							alert('필수항목을 입력해주세요')
						}
					})
		     } else if (!$(this).hasClass("active")){ //좋아요를 취소했을 경우
		    	 //총 좋아요수 처리
		    	 let likeCount = $('#likeCount').text();
		    	 $('#likeCount').text(parseInt(likeCount) - 1);
		    	 
		    	//post방식으로 좋아요 취소하기
		    	 $.ajax({
						url : "/likes/lDelete",
						method : 'post',
						contentType : 'application/x-www-form-urlencoded',
						data : {userId:userId, targetNo:targetNo, category:category},
						beforeSend : function(xhr)
		                {
		    				xhr.setRequestHeader(header, token);
		                },
						success : function(data) {
							//alert('좋아요 취소 완료');
						},
						fail : function(result) {
							alert('필수항목을 입력해주세요')
						}
					})
		     }
		 })
		 
		 $("#love").on("click", function() {
			 range();
		 })
		 
		 $('#order').change(function() {
 			range();
 		 });
		 
		//정렬 리스트 불러오는 함수
	  	function range() {
	 		//정렬 기준
	 		let userId = '[[${session.member != null ? session.member.userId :''}]]';
			let lclsf = $("input[name=lclsf]:checked").val();
			let type = 'T06';
			let order = $("#order option:selected").val();
			
			//get방식으로 보내기	
			if($("#love").hasClass("active")){ //하트가 눌렸을 경우 실행
				location.href=`/prtfl/mcList?order=${order}&userId=${userId}`
			} else if (!$("#love").hasClass("active")){ //하트가 눌리지 않았을 경우 실행
				location.href=`/prtfl/mcList?order=${order}`
			}
	  	} 
	</script>
</div>
</html>