<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default_layout}">

<div layout:fragment="content">

	<section class="module bg-dark-60 gallery-page-header parallax-bg"
		data-background="assets/images/gallery_bg.jpg"
		style="background-image: url(&quot;assets/images/gallery_bg.jpg&quot;);">
		<div class="container">
			<div class="row">
				<div class="col-sm-6 col-sm-offset-3">
					<h2 class="module-title font-alt">상세조회</h2>
					<div class="module-subtitle font-serif">Small Title</div>
				</div>
			</div>
		</div>
	</section>

	<!-- 현재 로그인된 id와 작성자id가 동일할 경우 버튼 나타남 -->
	<th:block th:if="${session.member.userId} == ${proDetail.userId}">
	</th:block>

	<section class="ftco-section ftco-degree-bg">
		<div class="container">
			<div class="row">
				<div class="col-lg-8 ftco-animate">
					<h2 class="mb-3 mt-5" th:text=${proDetail.proNo} id="proNo"></h2>
					<h2 class="mb-3" th:text=${proDetail.eName}></h2>
					<p th:text=${proDetail.userId}></p>
					<p th:text=${proDetail.eSday}></p>
					<p th:text=${proDetail.eEday}></p>
					<p th:text=${proDetail.loc}></p>
					<p th:text=${proDetail.intro}></p>
					<p th:text=${proDetail.eType}></p>
					<p th:text=${proDetail.entrance}></p>
					<p th:text=${proDetail.accommodate}></p>
					<p th:text=${proDetail.img}></p>
					<p th:text=${proDetail.see}></p>

					<div class="tag-widget post-tag-container mb-5 mt-5">
						<div class="tagcloud">
							<a href="#" class="tag-cloud-link"
								th:onclick="|location.href='@{proUpdate(proNo=${proDetail.proNo})}'|">수정</a>
							<a href="#" class="tag-cloud-link"
								th:onclick="|location.href='@{proDelete(proNo=${proDetail.proNo})}'|">삭제</a>
						</div>
					</div>
					
					<!-- 이미지 나타내기 -->	
					<div th:each="f : ${file}">
				     <!-- <a th:href="|/fileView/${f.sevNm}|" class="image-popup prod-img-bg"> --> 
				       <img th:src="|/fileView/${f.sevNm}|" style="width: 250px; height: 250px" class="img-fluid" alt="Colorlib Template"></a>
				   	</div>
   	
					<!-- 댓글 -->
					<div class="pt-5 mt-5">
						<h3 class="mb-5">댓글</h3>
						<ul class="comment-list" id=reply>
						</ul>
					</div>
					<!-- 댓글 작성 -->
					<form action="replyInsert">
						<textarea name="replyCntn" id="replyCntn" rows="4" cols="30"></textarea>
						<button type="button" id="replyInsertBtn">댓글작성</button>
					</form>
				</div>
			</div>
		</div>
	</section>
	<script>
//csrf 설정
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");

	let userId = '[[${session.member.userId}]]'; //누가 작성했는지 db에 보냄
	let proNo = '[[${proDetail.proNo}]]';
	let boardCat = 'T02';
	
	//댓글 불러오는 ajax
	 $.ajax({
		url : '/replyList', //controller에서 설정한 경로
		method : 'post',
		data : JSON.stringify({replyTgt:proNo, boardCat:boardCat}),
		contentType : "application/json",
		beforeSend : function(xhr)
        {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
			xhr.setRequestHeader(header, token);
        }
	}).then(res => {
		for(reply of res){
			console.log(reply)
			//댓글일 경우
			if(reply.rerepTgt == null){
				$("#reply").append(make(reply));
			} else { //대댓글일 경우
				$("#" + reply.rerepTgt).append(makeRe(reply));
			}
		}
	})
	
	 //댓글 tr생성
	function make(reply){
		let delbtn = ''; 
		let userId = '[[${session.member != null ? session.member.userId :''}]]';
		
		if(reply.userId ==userId){
			delbtn = `<button class='repDelete' >삭제</button>`;			
		}
		
		let p =`
			<li class="comment">
				<div class="comment-body" id="${reply.replyNo}">
				<h3>${reply.userId}</h3>
	            <div class="meta">${reply.writingDt}</div>
	            <p>${reply.replyCntn}</p>
	            <button type="button" class="reply">Reply</button>
	            ${delbtn}
				</div>
			</li>`
		
		return p;
	}
	//대댓글 tr생성
	function makeRe(reply){
		let delBtn = '';
		let userId = '[[${session.member != null ? session.member.userId :''}]]';
		
		//댓글 작성자일 경우에만 삭제 버튼 생성
		if(reply.userId ==userId){
			delbtn = `<button class='repDelete'>삭제</button>`;			
		}
		//한 댓글당 대댓글은 한개만 달수 있기 때문에 댓글에 있는 reply 버튼 삭제
		$("#" + reply.rerepTgt).children('button:eq(0)').remove();
		
		let p = `<ul class="children">
        <li class="comment">
        <div class="comment-body"  id="${reply.replyNo}">
          <h3>${reply.userId}</h3>
          <div class="meta">${reply.writingDt}</div>
          <p>${reply.replyCntn}</p>
          ${delBtn}
        </div>
      </li>
    </ul>`
    
    return p; 
	}
	
	//댓글 추가
	$("#replyInsertBtn").on("click", function(){
		//textarea에 있는 값 들고 오기
		let replyCntn = $('#replyCntn').val();
		console.log(replyCntn)
		
		$.ajax({
			url : '/replyInsert', //controller에서 설정한 경로
			method : 'post',
			data : JSON.stringify({replyTgt:proNo, userId:userId, replyCntn:replyCntn, boardCat:boardCat}),
			contentType : "application/json",
			beforeSend : function(xhr)
	        {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token);
	        }
		}).then(res => {
				//댓글등록
				$('#reply').append(make(res));
				//내용 비워주기
				$('#replyCntn').val('');
		})
	});
	
	//reply버튼을 클릭했을 경우 대댓글 입력 폼 생성
	$(document).on('click', '.reply', function(e){
		e.preventDefault();
		//대댓글을 작성할 replyNo 구하기
		let rerepTgt = $(this).parent("div").attr('id');
		//대댓글 폼 생성
		$(this).parent("div").append(makeFrm(rerepTgt));
		//reply버튼 숨김
		$(this).hide();
	})
	
	//대댓글 폼
	function makeFrm(rerepTgt){
		let form = 
			`<form>
				<input type= "hidden" id="rerepTgt" name="rerepTgt" value="${rerepTgt}">
				<textarea class="form-control" id="replyCntn" name="replyCntn" rows="3"></textarea>
				<button type="button" id="rerepTgt" class="reply">답변</button>
			</form>`
					
		return form;
	}	
	
	//대댓글 추가
	$(document).on('click', '#rerepTgt', function(e){
		let replyCntn = $('#replyCntn').val();
		let rerepTgt = $('#rerepTgt').val();
		
		$(this).parent("form").remove();
		$.ajax({
   			url : '/replyInsert',
   			method : 'post',
   			data : JSON.stringify({replyTgt:proNo, userId:userId, replyCntn:replyCntn, boardCat:boardCat, rerepTgt:rerepTgt}),
   			contentType : "application/json",
   			beforeSend : function(xhr)
            {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token);
            }
   		}).then(res => {
   			
   			$("#" + res.rerepTgt).append(makeRe(res));
   		})
	})
	
	//댓글 삭제
	$(document).on('click', '.repDelete', function(e){
		let btn=$(this);
		let replyNo = $(this).parent("div").attr('id');
		$.ajax({
			url : '/replyDelete',
			type : 'POST',
			data : {
				replyNo : replyNo
			},
			beforeSend: function (xhr) {
				/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token); //403오류, type post일때 넣기
			},
			success : function(result){
				if(result ==1){
				btn.closest(".comment").remove();
			}
		}
	});		
});
	
</script>
</div>
</html>