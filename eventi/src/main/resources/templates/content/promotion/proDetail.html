<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default_layout}">

<div layout:fragment="content">

	<section class="module bg-dark-60 gallery-page-header parallax-bg"
		data-background="assets/images/gallery_bg.jpg"
		style="background-image: url(&quot;assets/images/gallery_bg.jpg&quot;);">
		<div class="container">
			<div class="row">
				<div class="col-sm-6 col-sm-offset-3">
					<h2 class="module-title font-alt"></h2>
					<div class="module-subtitle font-serif"></div>
				</div>
			</div>
		</div>
	</section>

	<!-- 현재 로그인된 id와 작성자id가 동일할 경우 버튼 나타남 -->
	<th:block th:if="${session.member.userId} == ${proDetail.userId}">
	</th:block>
 	<!-- <section class="module-small">
          <div class="container">
            <div class="row">
              <div class="col-sm-8 col-sm-offset-1">
                <div class="post">
                  <div class="post-thumbnail" >	<div th:each="f : ${file}">
				 <img th:src="|/fileView/${f.sevNm}|" style="width: 250px; height: 250px" class="img-fluid" alt="Colorlib Template">
			</div></div>
                  <div class="post-header font-alt">
                    <h1 class="post-title" th:text=${proDetail.eName}>Our trip to the Alps</h1>
                    <div class="post-meta" th:text=${proDetail.proNo} id="proNo"  >By&nbsp;<a href="#">Mark Stone</a>| 23 November | 3 Comments | <a href="#">Photography, </a><a href="#">Web Design</a>
                    </div>
                  </div>
                  
                  <div class="post-entry" >
                    <p th:text=${proDetail.userId}> The European languages are members of the same family. Their separate existence is a myth. For science, music, sport, etc, Europe uses the same vocabulary. The languages only differ in their grammar, their pronunciation and their most common words.</p>
                    <p th:text=${proDetail.eType}>Everyone realizes why a new common language would be desirable: one could refuse to pay expensive translators. To achieve this, it would be necessary to have uniform grammar, pronunciation and more common words.</p>
                      <p th:utext=${proDetail.intro}>Lorem </p>
                    <ul>
                      <li th:text="${#dates.format(proDetail.eSday, 'yyyy-MM-dd')}">The European languages are members of the same family.</li>
                      <li th:text="${#dates.format(proDetail.eEday, 'yyyy-MM-dd')}">Their separate existence is a myth.</li>
                      <li th:text=${proDetail.loc}>For science, music, sport, etc, Europe uses the same vocabulary.</li>
                      <li th:text=${proDetail.entrance}>Their separate existence is a myth.</li>
                      <li th:text=${proDetail.accommodate}>Their separate existence is a myth.</li>
                    </ul>
                    <p th:text=${proDetail.see}>The European languages are members of the same family. Their separate existence is a myth. For science, music, sport, etc, Europe uses the same vocabulary. The languages only differ in their grammar, their pronunciation and their most common words.</p>
                    <div class="tag-widget post-tag-container mb-5 mt-5">
						<div class="tagcloud">
							<a href="#" class="tag-cloud-link"
								th:onclick="|location.href='@{proUpdate(proNo=${proDetail.proNo})}'|">수정</a>
							<a href="#" class="tag-cloud-link"
								th:onclick="|location.href='@{proDelete(proNo=${proDetail.proNo})}'|">삭제</a>
						</div>
					</div>
                  </div>
                  
                </div>
                <div class="comments"  id=reply>
                  <h4 class="comment-title font-alt">There are comments</h4>
                  <div class="comment clearfix">
                    <div class="comment-avatar"><img src="https://s3.amazonaws.com/uifaces/faces/twitter/ryanbattles/128.jpg" alt="avatar"></div>
                    <div class="comment-content clearfix">
                      <div class="comment-author font-alt"><a href="#">John Doe</a></div>
                      <form action="replyInsert">
						<textarea name="replyCntn" id="replyCntn" rows="4" cols="30"></textarea>
						<button type="button" id="replyInsertBtn">댓글작성</button>
                      Today, 14:55 - 
                    	</form>
                      </div>
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>
       </section>  -->
       
       <section class="module">
          <div class="container">
            <div class="row">
              <div class="col-sm-8">
                <div class="post">
                  <div class="post-thumbnail"><div th:each="f : ${file}">
				 <img th:src="|/fileView/${f.sevNm}|" style="width: 250px; height: 250px" class="img-fluid" alt="Colorlib Template"></div></div>
				 
                  <div class="post-header font-alt">
                    <h1 class="post-title" th:text=${proDetail.eName}>Our trip to the Alps</h1>
                    <div class="post-meta" th:text=${proDetail.proNo} id="proNo"  >By&nbsp;<a href="#">Mark Stone</a>| 23 November | 3 Comments | <a href="#">Photography, </a><a href="#">Web Design</a>
                    </div>
                  </div>
                   <div class="post-entry" >
                    <p th:text=${proDetail.userId}> The European languages are members of the same family. Their separate existence is a myth. For science, music, sport, etc, Europe uses the same vocabulary. The languages only differ in their grammar, their pronunciation and their most common words.</p>
                    <p th:text=${proDetail.eType}>Everyone realizes why a new common language would be desirable: one could refuse to pay expensive translators. To achieve this, it would be necessary to have uniform grammar, pronunciation and more common words.</p>
                      <p th:utext=${proDetail.intro}>Lorem </p>
                    <ul>
                      <li th:text="${#dates.format(proDetail.eSday, 'yyyy-MM-dd')}">The European languages are members of the same family.</li>
                      <li th:text="${#dates.format(proDetail.eEday, 'yyyy-MM-dd')}">Their separate existence is a myth.</li>
                      <li th:text=${proDetail.loc}>For science, music, sport, etc, Europe uses the same vocabulary.</li>
                      <li th:text=${proDetail.entrance}>Their separate existence is a myth.</li>
                      <li th:text=${proDetail.accommodate}>Their separate existence is a myth.</li>
                    </ul>
                    <p th:text=${proDetail.see}>The European languages are members of the same family. Their separate existence is a myth. For science, music, sport, etc, Europe uses the same vocabulary. The languages only differ in their grammar, their pronunciation and their most common words.</p>
                    <div class="tag-widget post-tag-container mb-5 mt-5">
						<div class="tagcloud">
							<a href="#" class="tag-cloud-link"
								th:onclick="|location.href='@{proUpdate(proNo=${proDetail.proNo})}'|">수정</a>
							<a href="#" class="tag-cloud-link"
								th:onclick="|location.href='@{proDelete(proNo=${proDetail.proNo})}'|">삭제</a>
						</div>
					</div>
                  </div>
                </div>
                
                <div class="post #">
                  <div class="post-header font-alt">
                    <h2 class="post-title"><a href="Post with text only">Mark Stone</a></h2>
                    <div class="post-meta">By&nbsp;<a href="#">| 23 November | 3 Comments | </a>Marketing, ,Web Design<a href="#">A</a><a href="#"> </a><a href="#">w</a><a href="#">o</a><a href="#">n</a><a href="#">d</a><a href="#">e</a><a href="#">r</a><a href="#">f</a><a href="#">u</a><a href="#">l</a><a href="#"> </a><a href="#">s</a><a href="#">e</a><a href="#">r</a><a href="#">e</a><a href="#">n</a><a href="#">i</a><a href="#">t</a><a href="#">y</a><a href="#"> </a><a href="#">h</a><a href="#">a</a><a href="#">s</a><a href="#"> </a><a href="#">t</a><a href="#">a</a><a href="#">k</a><a href="#">e</a><a href="#">n</a><a href="#"> </a><a href="#">p</a><a href="#">o</a><a href="#">s</a><a href="#">s</a><a href="#">e</a><a href="#">s</a><a href="#">s</a><a href="#">i</a><a href="#">o</a><a href="#">n</a><a href="#"> </a><a href="#">o</a><a href="#">f</a><a href="#"> </a><a href="#">m</a><a href="#">y</a><a href="#"> </a><a href="#">e</a><a href="#">n</a><a href="#">t</a><a href="#">i</a><a href="#">r</a><a href="#">e</a><a href="#"> </a><a href="#">s</a><a href="#">o</a><a href="#">u</a><a href="#">l</a><a href="#">,</a><a href="#"> </a><a href="#">l</a><a href="#">i</a><a href="#">k</a><a href="#">e</a><a href="#"> </a><a href="#">t</a><a href="#">h</a><a href="#">e</a><a href="#">s</a><a href="#">e</a><a href="#"> </a><a href="#">s</a><a href="#">w</a><a href="#">e</a><a href="#">e</a><a href="#">t</a><a href="#"> </a><a href="#">m</a><a href="#">o</a><a href="#">r</a><a href="#">n</a><a href="#">i</a><a href="#">n</a><a href="#">g</a><a href="#">s</a><a href="#"> </a><a href="#">o</a><a href="#">f</a><a href="#"> </a><a href="#">s</a><a href="#">p</a><a href="#">r</a><a href="#">i</a><a href="#">n</a><a href="#">g</a><a href="#"> </a><a href="#">w</a><a href="#">h</a><a href="#">i</a><a href="#">c</a><a href="#">h</a><a href="#"> </a><a href="#">I</a><a href="#"> </a><a href="#">e</a><a href="#">n</a><a href="#">j</a><a href="#">o</a><a href="#">y</a><a href="#"> </a><a href="#">w</a><a href="#">i</a><a href="#">t</a><a href="#">h</a><a href="#"> </a><a href="#">m</a><a href="#">y</a><a href="#"> </a><a href="#">w</a><a href="#">h</a><a href="#">o</a><a href="#">l</a><a href="#">e</a><a href="#"> </a><a href="#">h</a><a href="#">e</a><a href="#">a</a><a href="#">r</a><a href="#">t</a><a href="#">.</a><a href="#"> </a><a href="#">I</a><a href="#"> </a><a href="#">a</a><a href="#">m</a><a href="#"> </a><a href="#">a</a><a href="#">l</a><a href="#">o</a><a href="#">n</a><a href="#">e</a><a href="#">,</a><a href="#"> </a><a href="#">a</a><a href="#">n</a><a href="#">d</a><a href="#"> </a><a href="#">f</a><a href="#">e</a><a href="#">e</a><a href="#">l</a><a href="#"> </a><a href="#">t</a><a href="#">h</a><a href="#">e</a><a href="#"> </a><a href="#">c</a><a href="#">h</a><a href="#">a</a><a href="#">r</a><a href="#">m</a><a href="#"> </a><a href="#">o</a><a href="#">f</a><a href="#"> </a><a href="#">e</a><a href="#">x</a><a href="#">i</a><a href="#">s</a><a href="#">t</a><a href="#">e</a><a href="#">n</a><a href="#">c</a><a href="#">e</a><a href="#"> </a><a href="#">i</a><a href="#">n</a><a href="#"> </a><a href="#">t</a><a href="#">h</a><a href="#">i</a><a href="#">s</a><a href="#"> </a><a href="#">s</a><a href="#">p</a><a href="#">o</a><a href="#">t</a><a href="#">,</a><a href="#"> </a><a href="#">w</a><a href="#">h</a><a href="#">i</a><a href="#">c</a><a href="#">h</a><a href="#"> </a><a href="#">w</a><a href="#">a</a><a href="#">s</a><a href="#"> </a><a href="#">c</a><a href="#">r</a><a href="#">e</a><a href="#">a</a><a href="#">t</a><a href="#">e</a><a href="#">d</a><a href="#"> </a><a href="#">f</a><a href="#">o</a><a href="#">r</a><a href="#"> </a><a href="#">t</a><a href="#">h</a><a href="#">e</a><a href="#"> </a><a href="#">b</a><a href="#">l</a><a href="#">i</a><a href="#">s</a><a href="#">s</a><a href="#"> </a><a href="#">o</a><a href="#">f</a><a href="#"> </a><a href="#">s</a><a href="#">o</a><a href="#">u</a><a href="#">l</a><a href="#">s</a><a href="#"> </a><a href="#">l</a><a href="#">i</a><a href="#">k</a><a href="#">e</a><a href="#"> </a><a href="#">m</a><a href="#">i</a><a href="#">n</a><a href="#">e</a><a href="#">.</a>
                    </div>
                  </div>
                  <div class="post-entry">
                    <p></p>
                  </div>
                  <div class="post-more"><a class="more-link" href="Post with text only">Read more</a></div>
                </div>
                <div class="post">
                  <div class="post-quote">
                    <blockquote class="font-serif">
                      <p>" The languages only differ in their grammar, their pronunciation and their most common words. Everyone realizes why a new common language would be desirable: one could refuse to pay expensive translators. "</p>
                      <p class="font-inc font-uppercase">- Thomas Anderson</p>
                    </blockquote>
                  </div>
                </div>
                <div class="post">
                  <div class="post-video embed-responsive embed-responsive-16by9">
                    <iframe class="embed-responsive-item" src="//www.youtube.com/embed/Jkk0VHiCnKY" frameborder="0" allowfullscreen="allowfullscreen"></iframe>
                  </div>
                  <div class="post-header font-alt">
                    <h2 class="post-title"><a href="#">Post with video</a></h2>
                    <div class="post-meta">By&nbsp;<a href="#">Mark Stone</a>| 23 November | 3 Comments | <a href="#">Marketing, </a><a href="#">Web Design</a>
                    </div>
                  </div>
                  <div class="post-entry">
                    <p>A wonderful serenity has taken possession of my entire soul, like these sweet mornings of spring which I enjoy with my whole heart. I am alone, and feel the charm of existence in this spot, which was created for the bliss of souls like mine.</p>
                  </div>
                  <div class="post-more"><a class="more-link" href="#">Read more</a></div>
                </div>
                
                <!-- 댓글 -->
                 <div class="comments"  id=reply>
                  <h4 class="comment-title font-alt">There are comments</h4>
                  <div class="comment clearfix">
                    <div class="comment-avatar"><img src="https://s3.amazonaws.com/uifaces/faces/twitter/ryanbattles/128.jpg" alt="avatar"></div>
                    <div class="comment-content clearfix">
                      <div class="comment-author font-alt"><a href="#">John Doe</a></div>
                      <form action="replyInsert">
						<textarea name="replyCntn" id="replyCntn" rows="4" cols="30"></textarea>
						<button type="button" id="replyInsertBtn">댓글작성</button>
                      Today, 14:55 - 
                    	</form>
                      </div>
                    </div>
                  </div>
              </div>
              
              <!-- 사이드바 -->
              <div class="col-sm-4 col-md-3 col-md-offset-1 sidebar">
                <div class="widget">
                  <form role="form">
                    <div class="search-box">
                      <input class="form-control" type="text" placeholder="Search...">
                      <button class="search-btn" type="submit"><i class="fa fa-search"></i></button>
                    </div>
                  </form>
                </div>
                <div class="widget">
                  <h5 class="widget-title font-alt">Blog Categories</h5>
                  <ul class="icon-list">
                    <li><a href="#">Photography - 7</a></li>
                    <li><a href="#">Web Design - 3</a></li>
                    <li><a href="#">Illustration - 12</a></li>
                    <li><a href="#">Marketing - 1</a></li>
                    <li><a href="#">Wordpress - 16</a></li>
                  </ul>
                </div>
                
                <!-- 인기게시물 조회 -->
                <div class="widget">
                  <h5 class="widget-title font-alt">Popular Posts</h5>
                  <ul class="widget-posts" th:each="post : ${contents}">
                    <li class="clearfix">
                      <div class="widget-posts-image"><a href="#"><img src="assets/images/rp-1.jpg" alt="Post Thumbnail"></a></div>
                      <div class="widget-posts-body">
                        <div class="widget-posts-title" th:text=${post.eName}><a href="#">Designer Desk Essentials</a></div>
                        <div class="widget-posts-meta" th:text=${post.see}>23 january</div>
                      </div>
                    </li>
                  </ul>
                </div>
                <div class="widget">
                  <h5 class="widget-title font-alt">Tag</h5>
                  <div class="tags font-serif"><a href="#" rel="tag">Blog</a><a href="#" rel="tag">Photo</a><a href="#" rel="tag">Video</a><a href="#" rel="tag">Image</a><a href="#" rel="tag">Minimal</a><a href="#" rel="tag">Post</a><a href="#" rel="tag">Theme</a><a href="#" rel="tag">Ideas</a><a href="#" rel="tag">Tags</a><a href="#" rel="tag">Bootstrap</a><a href="#" rel="tag">Popular</a><a href="#" rel="tag">English</a>
                  </div>
                </div>
                <div class="widget">
                  <h5 class="widget-title font-alt">Text</h5>The languages only differ in their grammar, their pronunciation and their most common words. Everyone realizes why a new common language would be desirable: one could refuse to pay expensive translators.
                </div>
                <div class="widget">
                  <h5 class="widget-title font-alt">Recent Comments</h5>
                  <ul class="icon-list">
                    <li>Maria on <a href="#">Designer Desk Essentials</a></li>
                    <li>John on <a href="#">Realistic Business Card Mockup</a></li>
                    <li>Andy on <a href="#">Eco bag Mockup</a></li>
                    <li>Jack on <a href="#">Bottle Mockup</a></li>
                    <li>Mark on <a href="#">Our trip to the Alps</a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </section>
	<script>
//csrf 설정
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");

	let userId = '[[${session.member.userId}]]'; //누가 작성했는지 db에 보냄
	let proNo = '[[${proDetail.proNo}]]';
	let boardCat = 'T02';
	
	
	
	//댓글 불러오는 ajax
	 $.ajax({
		url : '/replyList', //controller에서 설정한 경로
		method : 'post',
		data : JSON.stringify({replyTgt:proNo, boardCat:boardCat}),
		contentType : "application/json",
		beforeSend : function(xhr)
        {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
			xhr.setRequestHeader(header, token);
        }
	}).then(res => {
		for(reply of res){
			console.log(reply)
			//댓글일 경우
			if(reply.rerepTgt == null){
				$("#reply").append(make(reply));
			} else { //대댓글일 경우
				$("#" + reply.rerepTgt).append(makeRe(reply));
			}
		}
	})
	
	 //댓글 tr생성
	function make(reply){
		let delbtn = '';
		let upBtn = '';
		let userId = '[[${session.member != null ? session.member.userId :''}]]';
		
		if(reply.userId ==userId){
			delbtn = `<button class='repDelete' >삭제</button>`;
			upBtn = `<button class='repUpdate'>수정</button>`;
		}
		
		let p =`
			<li class="comment">
				<div class="comment-body" id="${reply.replyNo}">
				<h3>${reply.userId}</h3>
	            <div class="meta">${reply.writingDt}</div>
	            <p>${reply.replyCntn}</p>
	            <button type="button" class="reply">Reply</button>
	            ${delbtn} ${upBtn}
				</div>
			</li>`
		
		return p;
	}
	//대댓글 tr생성
	function makeRe(reply){
		let delBtn = '';
		let upBtn = '';
		let userId = '[[${session.member != null ? session.member.userId :''}]]';
		
		//댓글 작성자일 경우에만 삭제 버튼 생성
		if(reply.userId ==userId){
			delbtn = `<button class='repDelete'>삭제</button>`;
			upBtn = `<button class='repUpdate'>수정</button>`;
		}
		//한 댓글당 대댓글은 한개만 달수 있기 때문에 댓글에 있는 reply 버튼 삭제
		$("#" + reply.rerepTgt).children('button:eq(0)').remove();
		
		let p = `<ul class="children">
        <li class="comment">
        <div class="comment-body"  id="${reply.replyNo}">
          <h3>${reply.userId}</h3>
          <div class="meta">${reply.writingDt}</div>
          <p>${reply.replyCntn}</p>
          ${delBtn} ${upBtn}
        </div>
      </li>
    </ul>`
    
    return p; 
	}
	
	//댓글 추가
	$("#replyInsertBtn").on("click", function(){
		//textarea에 있는 값 들고 오기
		let replyCntn = $('#replyCntn').val();
		console.log(replyCntn)
		
		$.ajax({
			url : '/replyInsert', //controller에서 설정한 경로
			method : 'post',
			data : JSON.stringify({replyTgt:proNo, userId:userId, replyCntn:replyCntn, boardCat:boardCat}),
			contentType : "application/json",
			beforeSend : function(xhr)
	        {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token);
	        }
		}).then(res => {
				//댓글등록
				$('#reply').append(make(res));
				//내용 비워주기
				$('#replyCntn').val('');
		})
	});
	
	//reply버튼을 클릭했을 경우 대댓글 입력 폼 생성
	$(document).on('click', '.reply', function(e){
		e.preventDefault();
		//대댓글을 작성할 replyNo 구하기
		let rerepTgt = $(this).parent("div").attr('id');
		//대댓글 폼 생성
		$(this).parent("div").append(makeFrm(rerepTgt));
		//reply버튼 숨김
		$(this).hide();
	})
	
	//대댓글 폼
	function makeFrm(rerepTgt){
		let form = 
			`<form>
				<input type= "hidden" id="rerepTgt" name="rerepTgt" value="${rerepTgt}">
				<textarea class="form-control" id="cntn" name="cntn" rows="3"></textarea>
				<button type="button" id="rerepTgt" class="reply">답변</button>
			</form>`
					
		return form;
	}	
	
	//대댓글 추가
	$(document).on('click', '#rerepTgt', function(e){
		let cntn = $('#cntn').val();
		let rerepTgt = $('#rerepTgt').val();
		
		$(this).parent("form").remove();
		$.ajax({
   			url : '/replyInsert',
   			method : 'post',
   			data : JSON.stringify({replyTgt:proNo, userId:userId, replyCntn:cntn, boardCat:boardCat, rerepTgt:rerepTgt}),
   			contentType : "application/json",
   			beforeSend : function(xhr)
            {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token);
            }
   		}).then(res => {
   			
   			$("#" + res.rerepTgt).append(makeRe(res));
   		})
	})
	
	//댓글 삭제
	$(document).on('click', '.repDelete', function(e){
		let btn=$(this);
		let replyNo = $(this).parent("div").attr('id');
		$.ajax({
			url : '/replyDelete',
			type : 'POST',
			data : {
				replyNo : replyNo
			},
			beforeSend: function (xhr) {
				/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token); //403오류, type post일때 넣기
			},
			success : function(result){
				if(result ==1){
				btn.closest(".comment").remove();
			}
		}
	});		
});
	
	//댓글 수정 폼으로 변경
	$(document).on('click', '.repUpdate', function(e){
		let replyNo = $(this).parent("div").attr('id');
		let p = $(this).parent("div").children("p").text();			
		$(this).parent().children('p').replaceWith("<div><input type='hidden' id='replyNo' name='replyNo' value='" + replyNo +"'></input> <input type='text' id='replyCntn' name='replyCntn' value='" + p + "'></input>");
		
		$(this).toggleClass("updateBtn");
	});
	
	//댓글 수정
	$(document).on('click', '.updateBtn', function(e){
		$(this).toggleClass("updateBtn");
		let btn = $(this);
		let replyCntn = $('#replyCntn').val();
		let replyNo = $('#replyNo').val();
		let updateBtn = `<button class='repUpdate'>수정</button>`;
		
		$.ajax({
			url : '/replyUpdate',
			type : 'POST',
			data : JSON.stringify({replyNo : replyNo, replyCntn : replyCntn}),
			contentType : "application/json",
			beforeSend: function (xhr) {
				/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token); //403오류, type post일때 넣기
			},
			success : function(result){
				btn.parent().children('div:eq(1)').replaceWith("<p>" + result.replyCntn + "</p>");
			}		
		})
	});
</script>
</div>
</html>