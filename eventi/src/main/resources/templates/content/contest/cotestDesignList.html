<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default_layout}">
<head>
<!-- 1.사이드바 css적용 -->
<link rel="stylesheet" href="/css/myPageSide.css">

<title>Insert title here</title>
<style>
img {
	margin-top: 50px;
	margin-right: 20px;
}
/* The Modal (background) */
.modal {
	display: none; /* Hidden by default */
	position: fixed; /* Stay in place */
	z-index: 1; /* Sit on top */
	padding-top: 100px; /* Location of the box */
	left: 0;
	top: 0;
	width: 120%; /* Full width */
	height: 100%; /* Full height */
	overflow: auto; /* Enable scroll if needed */
	background-color: rgb(0, 0, 0); /* Fallback color */
	background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
	background-color: #fefefe;
	margin: auto;
	padding: 20px;
	border: 1px solid #888;
	width: 40%;
	height: 60%;
	text-align: left;
	max-height: calc(100vh - 200px);
    overflow-y: auto;
	
}

/* The Close Button */
.close {
	color: #aaaaaa;
	float: right;
	font-size: 28px;
	font-weight: bold;
	text-align: right;
	
}

.close:hover, .close:focus {
	color: #000;
	text-decoration: none;
	cursor: pointer;
	
}
#modelBtn{
	text-align: center;
}
.modelBtn1 {
	display :inline-block;
}
</style>
</head>
<body>
	<!-- 2.레이아웃 content적용 -->
	<div layout:fragment="content" class="content">
	<div style="min-height: 3000px">
		<section class="module bg-dark-60 gallery-page-header parallax-bg" data-background="/assets/images/gallery_bg.jpg" style="background-image: url(&quot;assets/images/gallery_bg.jpg&quot;);">
          <div class="container">
            <div class="row">
              <div class="col-sm-6 col-sm-offset-3">
                <h2 class="module-title font-alt">마이페이지</h2>
                <div class="module-subtitle font-serif" th:text="|${cNo} 지원자 조회|"></div>
              </div>
            </div>
          </div>
        </section>
	
			<!-- 3.현재페이지 myPageSide 적용 -->
			<th:block th:replace="fragments/myPageSide :: myPageSide"></th:block>
	
			<!-- 지원자 디자인 리스트 -->
			<div class="container">
				<div class="row multi-columns-row" id="boxList"> 
				</div>
			<!-- end -->
			
			<!-- //페이징 경로 :: 문자 -->
				<div class="row mt-5" id="paging">
					<div class="col text-center">
						<div class="block-27" id="returnPaging">
						</div>
					</div>
				</div>
	
			<!-- The Modal -->
			<div id="myModal" class="modal">
	
				<!-- Modal content -->
				<div class="modal-content">
					<span class="close">&times;</span>
					<h3 id="title"></h3>
					<div id="modelSelect"></div>
				</div>
			</div>
		</div>
		<!-- 우승자 등록 -->
		<div class="col-sm-8 col-sm-offset-2">
                <h4 class="font-alt mb-0">우승자 등록</h4>
                <hr class="divider-w mt-10 mb-20">
                <form class="form" role="form" action="/winner/update" name="winnerfrm" method="post">
	                  <input type="hidden" id="token" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
	                  <input type="hidden" th:name="coNo" th:value="${cNo}"/>
	                  <div class="form-group">
	                    1등<input class="form-control input-lg" type="text" id="grade_01" name="dgnNo[]" required="required">
	                  </div>
	                  <div class="form-group">
	                    2등<input class="form-control input-lg" type="text" id="grade_02" name="dgnNo[]">
	                  </div>
	                  <div class="form-group">
	                    3등<input class="form-control input-lg " type="text" id="grade_03" name="dgnNo[]">
	                  </div>
	                  
               		  <button type="reset" class="btn btn-g btn-round btn-lg">초기화</button>	
	                  <button type="submit" class="btn btn-g btn-round btn-lg">등록</button>
                </form>
          </div>
		<!-- 페이지처리를 위한 히든인풋. -->
		<input type="hidden" name="page" value="1">
		</div>
		

		<script>
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	select(); 
	
	//접수된 각 대표디자인1건에 대한 리스트
	function select(){
		let cNo ='[[${cNo}]]';
		let page = $('input[name="page"]').val(); //페이지처리를 위한 변수.
		
		$.ajax({
			url: '/contest/ajaxDesignRead',
			method: 'post',
			//조회번호,페이지번호 넘기기.
			data: {cNo,page}, 
			beforeSend: function (xhr) {
				/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token);
			},
		}).then(res => {
			console.log(res);
			console.log(res.paging);
			if(res.design == 0){
				alert('지원자가 없습니다.')
				location.href = '/contest/mySelect';
			}else{
				
				$('#boxList').empty();
				//1건의 디자인에 대한 파일리스트..
				for(design of res.design){
					
					let dNo = design.dgnNo;
					let title = design.name;
					let userId = design.userId;
					/*  console.log(design.files)  */
					
					for(file of design.files){
						//디자인 파일리스트 중 대표이미지가 같을경우 생성.
						if(design.centerImg == file.fNm){
							makeImg(file.sevNm,title,dNo,userId);
						}
							
					}
				}
				
				$('#returnPaging').empty();
				$('#returnPaging').append(makePageing(res.paging));
			}
		})
	}
	
	//디자인 응모작품 생성.
	function makeImg(fileName,title,dNo,userId){
		
		let design = ` <div class="col-sm-6 col-md-4 col-lg-4 design" id="${dNo}">
				            <div class="shop-item">
				            <div class="shop-item-image"><img src="/fileView/${fileName}" style="width: 500px; height: 500px">
				              <div class="shop-item-detail">

				              <div>
					   				  <h3 class="content-box-title font-serif dNo">${dNo}</h3>
					   				  <h3 class="content-box-title font-serif">회원:${userId}</h3>
					   				  <h3 class="content-box-title font-serif">제목:${title}</h3>
				              </div>
				              <div class="btn btn-round btn-b">
					              <span id="${dNo}" class="icon-magnifying-glass winner">우승자등록</span></a>
				              </div>
				            </div>
				          </div>
				        </div> `;
		
			$('#boxList').append(design);
		
	}
	//-----------------------------------------------------------------------------------------
	// 우승자등록버튼 
	$('#boxList').on("click", ".winner" , function(e){
		let dNo = $(this).attr("id");
		e.stopPropagation();
		$('input[name="dgnNo[]"]').each(function (i) {
			if($(this).val() == '' || null || undefined || 0 || NaN){
				$(this).val(dNo);
				index ++;
			}
		});
	});
	
	
	//디자인선택시 모달창 
	//응모된 1건의 디자인
	// 전체 파일리스트+ 정보출력.
	$('#boxList').on("click", ".design" , function(e){
		let dNo = $(this).attr("id");

		
		$.ajax({
			url: '/design/ajaxSelect',
			method: 'post',
			data: {dgnNo:dNo},
			beforeSend: function (xhr) {
				/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token);
			},
		}).then(res => {
			console.log(res);
			let user = res.userId;
			let title = res.name;
			let cntn = res.cntn;
			
			$('#title').empty();
			let content = `<h3>${user} 님의 참여작품 </h3>
							<p>작품명 : ${title} </p>
							<p>${cntn} </p>
						  `
			
			$('#title').append(content);
			
			//모달내용을 지운뒤 붙여넣기.
			$('#modelSelect').empty();
			for(file of res.files){
				makeDesign(file.sevNm,title,dNo);
			}
			
		})
	})
	
	//모달창 :디자인 응모작품 생성.
	function makeDesign(fileName,dNo){
		let design = `  <div class="design" id="${dNo}" style="float: left ">
								<img src="/fileView/${fileName}" style="width: 500px; height: 500px">
					   </div>
					  `
			$('#modelSelect').append(design);
		
	}
	//----------------------------------------------------------------------------------------------------
	//페이지 이동 함수
	function gopage(i) {
		$('input[name="page"]').val(i); //페이징처리를 위한 input값 변경.
		select();
	}
	
	// 페이징 만들기
	function makePageing(page) {
		if (page.totalRecord == 0) {
			return;
		}
		let pagination = $("<div/>").addClass("block-27");
		let ul = $("<ul/>").attr("class","pagination");
		if (page.startPage > 1) {
			$(ul).append($("<li/>").html("&laquo;")
				.css("font-size", "30px")
				.on("click", function () {
					gopage(page.startPage - page.pageSize)
				}));
		}

		//페이지 버튼 생성.
		for (let i = page.startPage; i <= page.endPage; i++) {
			if (page.page == i) {
				$(ul).append($("<li/>").text(i).attr("class", "active")
					.css("border-radius", "100%")
					.css("color", "#000")
					.css("background", "LightGray")
				);
			} else {
				$(ul).append($("<li/>").text(i).attr("class", "page-link")
					.css("border-radius", "100%")
					.css("color", "#000")
					.on("click", function () {
						gopage($(this).text());
					})); //페이지이동 함수
			}
		}
		if (page.endPage < page.lastPage) {
			$(ul).append($("<li/>").html("&raquo;")
				.css("font-size", "30px")
				.on("click", function () {
					gopage(page.startPage + page.pageSize)
				}));
		}
		pagination.append(ul);
		return pagination;
	}

	
	
			// Get the modal
			var modal = document.getElementById("myModal");
			
			// Get the button that opens the modal
			var btn = document.getElementById("boxList"); //태그id 변경시 확인!!
			
			// Get the <span> element that closes the modal
			var span = document.getElementsByClassName("close")[0];
			
			// When the user clicks the button, open the modal 
			$('btn').on("click",function() {
			  modal.style.display = "block";
			})
			
			// When the user clicks on <span> (x), close the modal
			span.onclick = function() {
			  modal.style.display = "none";
			}
			
			// When the user clicks anywhere outside of the modal, close it
			window.onclick = function(event) {
			  if (event.target == modal) {
			    modal.style.display = "none";
			  }
			}

	
	</script>
	</div>
</body>
</html>