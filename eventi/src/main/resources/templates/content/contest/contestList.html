<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default_layout}"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
<link rel="stylesheet" href="/css/model.css">
<link rel="stylesheet" href="/css/heart.css">
</head>
<style>
</style>
<body>
	<div layout:fragment="content" class="content">
		<section class="module bg-dark-60 gallery-page-header parallax-bg" data-background="/assets/images/gallery_bg.jpg" style="background-image: url(&quot;assets/images/gallery_bg.jpg&quot;);">
          <div class="container">
            <div class="row">
              <div class="col-sm-6 col-sm-offset-3">
                <h2 class="module-title font-alt">공모전</h2>
                <div class="module-subtitle font-serif">전체리스트</div>
              </div>
            </div>
          </div>
        </section>


		<section class="module-small">
          <div class="container">
              <!-- 공모전 정렬기준 -->
              <div class="col-sm-3 mb-sm-20">
                <select id="order" name="order" class="form-control">
					<option value="inq DESC" selected="selected">조회수</option>
					<option value="pay DESC">금액순</option>
					<option value="dDay">마감일 빠른순</option>
					<option value="dDay DESC">마감 느린순</option>
                </select>
              </div>
              
              
              	<!-- 분류별 기준 뽑아오기 -->
              	 <div class="col-sm-3 mb-sm-20">
	                <div>
	                		<input type="checkbox" name="category" value="D1" onclick="doOpenCheck(this);">현수막
							<input type="checkbox" name="category" value="D2" onclick="doOpenCheck(this);">배너
							<input type="checkbox" name="category" value="D3" onclick="doOpenCheck(this);">로고
							<input type="checkbox" name="category" value="D4" onclick="doOpenCheck(this);">포스터
							<input type="checkbox" name="category" value="D5" onclick="doOpenCheck(this);">기타
					</div>
                </div>
              
              <div class="col-sm-3">
              	<!-- 비회원 공모전작성버튼-->
				<th:block sec:authorize="!isAuthenticated()">
					<button class="btn btn-block btn-round btn-g" onclick="login()">공모전 작성</button></a>
				</th:block>
				
				<!-- 일반회원 공모전작성버튼-->
				<th:block sec:authorize="isAuthenticated()">
					<a href="./insert"><button class="btn btn-block btn-round btn-g">공모전 작성</button></a>
				</th:block>
              </div>
              
              	<!-- 좋아요리스트 조회 및 공모전 작성 버튼 -->
					<!-- 비회원 좋아요버튼-->
				<div class="col-sm-3 mb-sm-20">
					<th:block sec:authorize="!isAuthenticated()">
						<div class="stage" style="float: right;">
							<div id="love" class="stage heart" onclick="login()"></div>
						</div>
					</th:block>
					
					<!-- 회원 좋아요버튼-->
					<th:block sec:authorize="isAuthenticated()">
						<div class="stage" style="float: right;">
							<div id="love" class="stage heart" onclick="loveClick(this)"></div>
						</div>
					</th:block>
				</div>
          </div>
        </section>
           

			<!-- 공모전 리스트 -->
			<div class="container">
				<div class="row multi-columns-row" id="boxList"  > </div>
			<!-- end -->

				<!-- //페이징 경로 :: 문자 -->
				<div class="row mt-5" id="paging">
					<div class="col text-center">
						<div class="block-27" id="returnPaging">
						</div>
					</div>
				</div>
		
				<!-- 페이징/정렬처리 -->
				<input type="hidden" name="orderSelect" value="dt_Reg">
				<input type="hidden" name="categorySelect" value="">
				<input type="hidden" name="page" value="1">
			</div>


			<!-- 자바스크립트 -->
			<script>
				var token = $("meta[name='_csrf']").attr("content");
				var header = $("meta[name='_csrf_header']").attr("content");
				contestList(); // 첫 화면 리스트출력

				function login(){
					 $("#header_modal").show();
				}
				
				function gopage(i) {
					let page = $('input[name="page"]').val(i);
					
					//하트가 눌렸을 경우 실행
					if ($("#love").hasClass("active")) { 
						loveClick()
					
					} else { //하트가 눌리지 않았을 경우 실행
						//정렬 리스트 불러오는 함수
						checkSelect();
					}
					
				}



				//공모전 기본 전체리스트
				function contestList() {
					$.ajax({
						url: '/contest/List',
						method: 'post',
						data: JSON.stringify({
							order
						}),
						contentType: "application/json",
						beforeSend: function (xhr) {
							/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
							xhr.setRequestHeader(header, token);
						},
					}).then(res => {
						//map =>  contest,paging 
						console.log(res.paging)
						for (contest of res.contest) {
							$('#boxList').append(makeBox(contest));
						}
						$('#returnPaging').append(makePageing(res.paging));
					})


					//정렬기준 변경 ex)조회순
					$('#order').on("change", function () {
						let order = $(this).val();
						$('input[name=orderSelect]').val(order);
						checkSelect();

					});



					//분류별 조회 선택 ex)현수막
					$('input[type=checkbox][name=category]').each(function (index) {
						$(this).change(function () {
							if (this.checked) {
								$('input[name=categorySelect]').val($(this).val());
							}
							checkSelect();
						});
					});

				};
				//전체리스트 끝

				//분류,정렬기준 전체확인 => 리스트 출력.
				function checkSelect() {
					let category = $('input[name=categorySelect]').val();
					let order = $('input[name=orderSelect]').val();
					let page = $('input[name=page]').val();

					$.ajax({
						url: '/contest/List',
						method: 'post',
						data: {
							category,
							order,
							page
						},
						beforeSend: function (xhr) {
							/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
							xhr.setRequestHeader(header, token);
						},
					}).then(res => {
						
						//등록된 공모전이 없을경우 기존페이지로 이동.
						if (res.contest == 0) {
							location.href = '/contest/List';
							alert('등록된 공모전이 없습니다');
						}else{
							//기존 리스트 삭제 -> div생성 붙여넣기
							$('#boxList').empty();
							for (contest of res.contest) {
								$('#boxList').append(makeBox(contest));
							}

							//기존 페이징 삭제 -> 다시붙여넣기
							$('#returnPaging').empty();
							$('#returnPaging').append(makePageing(res.paging));
						}
					}).catch(error => console.log(error));
				}

				//체크박스 1건만 선택가능하도록 설정.
				function doOpenCheck(check) {
					var obj = document.getElementsByName("category");
					for (var i = 0; i < obj.length; i++) {
						if (obj[i] != check) {
							obj[i].checked = false;
						}
					}
				}

				//공모전 1건의 대한 박스 생성
				function makeBox(contest) {
					//로그인 회원의 하트눌려진것만 체크
					let active = null;
					if(contest.userLike > 0){
						//console.log(contest.cNo);
						//console.log(contest.userLike);
						active = 'active';
					}
					let p = ` 
								<div class="col-sm-6 col-md-4 col-lg-4">
					                <div id="${contest.cNo}" class="shop-item">
					                  <div class="shop-item-image"><img src="/fileView/${contest.img}" style="width: 665px; height: 700px">
					                    <div class="shop-item-detail">
					                    	<div class="stage" >
							  					<div id="${contest.cNo}" class="stage heart ${active}" onclick="loveCheck(this)"></div>
							   				</div>
							   				<div>
							   				  <h3 class="content-box-title font-serif">${contest.cNo}</h3>
							   				  <h3 class="content-box-title font-serif">${contest.writer}</h3>
							   				  <h3 class="content-box-title font-serif">${contest.ttl}</h3>
							                  <h3 class="content-box-title font-serif">D-${contest.dDay}</h3>
							                  <h3 class="content-box-title font-serif">총상금 ${contest.pay} 원</h3>
							                  <p>
							                  	   <span>${contest.category}</span>
												   <span>#${contest.style}</span>
													신고<span id="rprt">${contest.rprt}</span>
													조회<span id="inq">${contest.inq}</span>
													관심<span id="likes">${contest.likes}</span>
											   </p>
											</div>
					                    	<a href="../contest/select?cNo=${contest.cNo}" class="btn btn-round btn-b">
					                    	<span class="icon-magnifying-glass">상세조회</span></a>
					                    </div>
					                  </div>
					                </div>
					              </div> `;
					return p;
				}


				// 페이징 만들기
				function makePageing(page) {
					if (page.totalRecord == 0) {
						return;
					}
					let pagination = $("<div/>")
					let ul = $("<ul/>").attr("class","pagination");
					if (page.startPage > 1) {
						$(ul).append($("<li/>").html("&laquo;")
												.css("font-size", "30px")
												.attr("class","page-item")
												.on("click", function () {
														gopage(page.startPage - page.pageSize)
												}));
					}

					//페이지 버튼 생성.
					for (let i = page.startPage; i <= page.endPage; i++) {
						if (page.page == i) {
							$(ul).append($("<li/>") .text(i).css("font-size", "20px")
													.css("padding", "10px")
													.css("border-radius", " 10% / 50% ")
													.css("background", "#dce3fd")
													.attr("class", "page-link active")
							);
						} else {
							$(ul).append($("<li/>").text(i).css("font-size", "20px")
													.css("padding", "10px")
													.attr("class", "page-link")
													.on("click", function () {
														gopage($(this).text());
													})); //페이지이동 함수
						}
					}
					if (page.endPage < page.lastPage) {
						$(ul).append($("<li/>").html("&raquo;")
												.css("font-size", "30px")
												.attr("class","page-item")
												.on("click", function () {
														gopage(page.startPage + page.pageSize)
												}));
					}
					pagination.append(ul);
					return pagination;
				}

				//공모전 전체하트를 클릭했을 경우 => 나의 좋아요 공모전박스 생성출력.
				function loveClick(e) {
					let page = $('input[name=page]').val();
					
					//active 클래스가 없을 경우 생성, 있을 경우 삭제
					$(e).toggleClass("active");

					if ($("#love").hasClass("active")) { //하트가 눌렸을 경우 실행

						$.ajax({
							url: '/contest/ajaxlike',
							method: 'post',
							data:{page},
							beforeSend: function (xhr) {
								/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
								xhr.setRequestHeader(header, token);
							},
						}).then(res => {
							//map =>  contest,paging 
							console.log(res);
							
							$('#boxList').empty();
							$('#cotestHeader').empty();
							
							
							//관심 공모전이 없을경우
							if(res.contest == ''){
								$('#boxList').append($('<p>').append("관심 공모전 없습니다."));
							}
							for (contest of res.contest) {
								$('#boxList').append(makeBox_map(contest));
							}

							$('#returnPaging').empty();
							$('#returnPaging').append(makePageing(res.paging));

						})
					} else if (!$("#love").hasClass("active")) { //하트가 눌리지 않았을 경우 실행
						//정렬 리스트 불러오는 함수
						checkSelect();
					}
				}


				//Map : 로그인회원의 좋아요 공모전박스생성
				 function makeBox_map(contest) {
					let p = ` 
						<div class="col-sm-6 col-md-4 col-lg-4">
			                <div id="${contest.C_NO}" class="shop-item">
			                  <div class="shop-item-image"><img src="/fileView/${contest.IMG}" style="width: 665px; height: 750px">
			                    <div class="shop-item-detail">
			                    	<div class="stage" >
					  					<div id="${contest.C_NO}" class="stage heart active" onclick="loveCheck(this)"></div>
					   				</div>
					   				<div>
					   				 <h3 class="content-box-title font-serif">${contest.C_NO}</h3>
					   				  <h3 class="content-box-title font-serif">${contest.WRITER}</h3>
					   				  <h3 class="content-box-title font-serif">${contest.TTL}</h3>
					   				  <h3 class="content-box-title font-serif">D-${contest.DDAY}</h3>
					                  <h3 class="content-box-title font-serif">총상금 ${contest.PAY} 원</h3>
					                  <p>
					                  	   <span>${contest.CATEGORY}</span>
										   <span>#${contest.STYLE}</span>
											신고<span id="rprt">${contest.RPRT}</span>
											조회<span id="inq">${contest.INQ}</span>
											관심<span id="likes">${contest.LIKES}</span>
									   </p>
									</div>
			                    	<a href="/contest/select?cNo=${contest.C_NO}" class="btn btn-round btn-b">
			                    	<span class="icon-magnifying-glass">상세조회</span></a>
			                    </div>
			                  </div>
			                </div>
			              </div> `;
					
					return p;
				} 

				//하트클릭시 DB입력(등록,취소)
				$('#boxList').on("click",".shop-item" ,function(){
					let cNo = $(this).attr("id");
					
				})
				//이벤트 e찾기..
				function loveCheck(e) {
					$(e).toggleClass("active");//css 변경
					//이벤트객체	console.log(this.contest);
					let category = 'T01';
					let targetNo = e.id; //이벤트 윈도우객체에서 찾기.
					
					//하트가 눌렸을 경우 실행
					if ($(e).hasClass("active")) {
						$.ajax({
							url: '/likes/lInsert',
							method: 'post',
							data: {targetNo,category},
							beforeSend: function (xhr) {
								/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
								xhr.setRequestHeader(header, token);
							},
						}).then(res => {
							if(res > 0){
								alert('관심공모전 추가완료!')
							}else{
								alert('관심공모전 추가실패!')
							}
						})

						//하트가 눌리지 않았을 경우 실행
					} else if (!($(e).hasClass("active"))) {
						//하트가 눌렸을 경우 실행
							$.ajax({
								url: '../likes/lDelete',
								method: 'post',
								data: {targetNo,category}, 
								beforeSend: function (xhr) {
									/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
									xhr.setRequestHeader(header, token);
								},
							}).then(res => {
								if(res > 0){
									alert('관심공모전 취소완료!')

									//전체하트가 눌려진 상태로 재실행
									if ($("#love").hasClass("active")) { 
										loveClick();
										
									//기본 정렬리스트 재실행
									}else{
										checkSelect();
									}
									
								}else{
									alert('관심공모전 취소실패!')
								}
							})
						}
				}
			</script>
		</div>
</body>

</html>