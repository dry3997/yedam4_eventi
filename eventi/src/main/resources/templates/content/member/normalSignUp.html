<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default_layout}">

<head>
	<link rel="stylesheet" href="/assets/css/btns.css">
	<style> 
		#container {
			width: 70%;
			margin: 0 auto;
		}
		
		#signInBox {
			padding: 20px;
    		min-height: 550px;
    		display: flex;
    		line-height: 3em;
    		flex-direction: column;
		}
		#signIn{
			display: flex;
		}

		#submitArea button {
			margin-left: 10px;
		}
		.quDelBtn {
			padding: 10px;
			cursor: pointer;
			background: 0 0;
			border: 0;
			font-size: 15px;
			color: #000;
			text-shadow: 0 1px 0 #fff;
			opacity: .5;
		}

		.quDelBtn:hover {
			color: #000;
			text-decoration: none;
			cursor: pointer;
			opacity: 1;
		}
	
		#signIn-left {
			padding: 20px;
			width: 50%;
			display: inline-block;
			border-right: 1px solid black;
		}

		#signIn-right {
			display:flex;
			flex-direction: column;
    		justify-content: space-between;
			padding: 20px;
			width: 50%;
		}

		#submitArea {
			position: relative;
			display:flex;
			justify-content: flex-end;
		}

		input {
			width: 300px;
			margin-right: 15px;
		}
		
		#qListdiv{
			max-height:300px;
			overflow:auto;
		}
		
		#qList li{
			height: 35px;
			font-size:17px;
			font-weight: 700;
			line-height:0;
		}
		.inputRadio {
			width: 20px;
		}

		.labelRadio {
			width: 80px;
			font-size:18px;
		}

		#modal {
			display: none;
			position: fixed;
			top: 25em;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 1;
			width: 100%;
		}

		#modal h2 {
			margin: 0;
		}

		#modal button {
			height: 40px;
			padding:10px;
		}
		
		.btn-warning {
		    color: #333;
		    font-weight:700;
		    background-color: #FAB955;
		    border-color: #eea236;
		}
		
		#modal .modal_content {
			width: 350px;
			min-height: 200px;
			margin: 0 auto;
			padding: 20px;
			background: #fff;
			border: 0.5px solid #666;
			border-radius: 5px;
			text-align:center;
		}

		#modal .modal_layer {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			z-index: -1;
		}

		#button_box {
			display: flex;
			margin-top: 40px;
			justify-content: flex-end;
		}
		
		#inputEmailChk {
			width: 140px;
    		grid-column-start: 2;
    		grid-row-start : 3;
		}
		
		.form-items{
			display: grid;
    		grid-template-columns: 130px 300px;
    		grid-template-rows: 50px 20px;
    		align-items:start;
    		margin-bottom:10px;
		}
		
		.feedbacks{
			grid-column-start:2;
			top: -10px;
  	 		position: relative;
  	 		
		}
		.form-label{
			font-size: 18px;
    		width: 120px;
    		margin-right: 10px;
    		text-align: right;
		}
		.form-items-email{
			display: grid;
    		grid-template-columns: 130px 310px 115px;
    		grid-template-rows: 50px 30px 50px 30px;
		}
		.form-items-crtf{
			display: grid;
		    grid-template-columns: 130px 310px 115px;
		    grid-template-rows: 50px 30px;
		    margin-bottom: 30px;
		}
		#email_feedback{
			grid-column-start: 2;
			grid-row-start:4;
			top: -10px;
    		position: relative;
		}
		.mail_input_box_warn{
			grid-column-start: 2;
    		grid-row-start : 2;
    		top: -10px;
    		position: relative;
		}
		.loginBtn{
			background-image: linear-gradient(45deg, #2fb380 50%, transparent 70%);
		}

	</style>
</head>

<body>
	<div layout:fragment="content">
		<div style="background-image: url(&quot;/assets/images/signUpNorm.jpg&quot;);padding-top: 60px;">
		<div id="container">
			<div id="signInBox">
				<form id="signIn" name="signIn" style="width: 100%;">
					<div id="signIn-left">
						<h3 class="mb-4 billing-heading" style="margin: 0px 0 30px 0;" align="center"><b>기본정보</b> (필수)</h3>
						
						<div class="form-items">
							<label for="inputId" class="form-label"><b>아이디</b></label>
							<input type="text" name="userId" id="inputId" maxLength="12" placeholder="최대 12글자의 영문자,숫자 조합">
							<font id="id_feedback" class="feedbacks" size="2" value="1"></font>
						</div>

						<div class="form-items">
							<label for="pw1" class="form-label">비밀번호</label>
							<input type="password" name="userPassword" id="pw1" maxLength="12" placeholder="숫자와 문자 포함 형태의 6~12자리 이내">
							<font id="pwc_feedback" class="feedbacks" size="2" value="1"></font>
						</div>
						
						<div class="form-items">
							<label for="passwordchk" class="form-label">비밀번호확인</label>
							<input type="password" name="passwordchk" id="pw2">
							<font id="pw_feedback" class="feedbacks" size="2" value="1"></font>
						</div>
						
						<div class="form-items">
							<label for="inputName" class="form-label">성명</label>
							<input type="text" name="name" id="inputName" placeholder="홍길동"><br>
						</div>
						
						<div class="form-items-email">
							<label for="inputEmail" class="form-label">이메일주소</label>
							<input type="email" name="userEmail" id="inputEmail" placeholder="eventi@eventi.com">
							<div>
								<button type='button' id="sendEmail" class="btn btn-default btn-round"><b>인증번호전송</b></button>
							</div>
							<span class="mail_input_box_warn"></span>
							<input id="inputEmailChk" type="text" placeholder="숫자 6자리의 인증번호">
							<font id="email_feedback" size="2" value="1"></font>
						</div>
						
						<div class="form-items">
							<label for="inputPhone" class="form-label">전화번호</label>
							<input type="tel" name="userPhone" id="inputPhone" pattern="[0-9]{3}-[0-9]{4}-[0-9]{4}" maxlength="11" placeholder=" - 제외 11자리 (010XXXXXXXX)"><br>
						</div>
						
						<div class="form-items-bank">
							<label for="bankCode" class="form-label">은행사</label>
							<select th:name="bank" id="bankCode" style="width:80px;height:48px;" required>
								<option value=""> 은행사 </option>
								<option th:each="bankCode : ${bankCode}" th:value="${bankCode.codeId}" th:text="${bankCode.codeName}"></option>
							</select>
							<input type="text" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" name="accnt" id="inputAccnt" placeholder="- 제외 숫자만" style="width:213px;" ><br>
						</div>
						
						<label class="form-label">메일 알림수신</label>
							<label><input type="radio" class="inputRadio" name="userMessaging" value="S1" checked>수신동의</label>
							<label><input type="radio" class="inputRadio" name="userMessaging" value="S0">수신거부</label>
					</div>
					<div id="signIn-right">
						<div>
							<h3 class="mb-4 billing-heading" style="margin: 0px 0 30px 0;" align="center"><b>사회자/디자이너회원 승급 신청</b> (선택)</h3>
							<div align="center">
							
							<input type="radio" class="inputRadio" name="certType" value="MC"><label
								class="labelRadio">사회자</label>
							<input type="radio" class="inputRadio" name="certType" value="DESIGNER"><label
								class="labelRadio">디자이너</label>
							</div>
							<div class="form-items">
								<label for="inputQna" class="form-label">자격증명</label>
								<input type="text" id="inputQna">
							</div>
							
							<div class="form-items-crtf">
								<label for="inputQno" class="form-label">자격증발급번호</label><input type="text" id="inputQno">
								<div>
									<button type='button' class="btn btn-default btn-round" id="qPlus"><b>추가</b></button>
								</div>
							</div>
							<div id="qListdiv">
								<ul id="qList">
								</ul>
							</div>
						</div>
					<div>
						<div id="submitArea">
							<button type='reset' class="btns grey" ><b>초기화</b></button>
							<button type='button' id="normalSignIn" class="btns yellow"><b>회원가입</b></button>
						</div>
					</div>
				</div>
				</form>
			</div>
		</div>
		</div>
		<div id="modal">
			<div class="modal_content">
				<h2 style="margin-bottom:40px;"><b>회원가입완료!</b></h2>
				<p><b>일반회원으로 활동하실 수 있습니다.</b></p>
				<div id="button_box">
					<button type="button" id="modal_login_btn" class="btns yellow loginBtn"
						th:onclick="|location.href='@{loginPage}'|">로그인</button>
					<button type="button" id="modal_main_btn" class="btns grey"
						th:onclick="|location.href='/'|">홈으로</button>
				</div>
			</div>
			<div class="modal_layer"></div>
		</div>

		<script>
		$(function () {
			var session = '[[${session.member != null? session.member.userId:""}]]';
			if (session != '') {
				window.location.href = '/'
			}
		})
			//csrf 설정
			var header = $("meta[name='_csrf_header']").attr("content");
			var token = $("meta[name='_csrf']").attr("content");

			/* 아이디 중복 확인 */
			$('#inputId').keyup(function () {
				var inputId = $('#inputId').val(); //입력한 ID
				if(!idFormCheck(inputId)){
					$("#id_feedback").html('사용할 수 없는 아이디 형식 입니다.');
					$("#id_feedback").attr('color', '#dc3545');
					$("#id_feedback").attr('value', '1');
				}else{
					$.ajax({
						url: "/memIdCheck",
						type: "post",
						data: {
							inputId: inputId
						},
						dataType: 'json',
						beforeSend: function (xhr) {
							/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
							xhr.setRequestHeader(header, token);
						},
						success: function (result) {
							if (result == 1) {
								$("#id_feedback").html('이미 사용중인 아이디입니다.');
								$("#id_feedback").attr('color', '#dc3545');
								$("#id_feedback").attr('value', '1');
							} else {
								$("#id_feedback").html('사용할 수 있는 아이디입니다.');
								$("#id_feedback").attr('color', '#2fb380');
								$("#id_feedback").attr('value', '0');
							}
						},
						error: function () {
							alert("서버 요청 실패");
						}
					})
				}	
			})

			//비밀번호 유효성 검사
			$('#pw1').keyup(function () {
				var p1 = $('#pw1').val();
				if (pwFormCheck(p1)) {
					$("#pwc_feedback").html('사용할 수 있는 비밀번호 입니다.');
					$("#pwc_feedback").attr('color', '#2fb380');
					$("#pwc_feedback").attr('value', '0');
				} else {
					$("#pwc_feedback").html('사용할 수 없는 비밀번호 입니다.');
					$("#pwc_feedback").attr('color', '#dc3545');
					$("#pwc_feedback").attr('value', '1');
				}
			})

			
			//아이디 형식 검사 메소드
			function idFormCheck(p1) {
				var form = /^[A-Za-z0-9]{6,12}$/;
				return form.test(p1);
			}
			
			//비밀번호 형식 검사 메소드
			function pwFormCheck(p1) {
				var form = /^[A-Za-z0-9]{6,12}$/;
				return form.test(p1);
			}

			/* 비밀번호 확인 */
			$('#pw2').keyup(function () {
				var p1 = $('#pw1').val(); //비밀번호 값
				var p2 = $('#pw2').val(); //비밀번호 확인
				if (p1 == p2) {
					$("#pw_feedback").html('비밀번호가 일치합니다.');
					$("#pw_feedback").attr('color', '#2fb380');
					$("#pw_feedback").attr('value', '0');
				} else {
					$("#pw_feedback").html('비밀번호가 일치하지 않습니다.');
					$("#pw_feedback").attr('color', '#dc3545');
					$("#pw_feedback").attr('value', '1');
				}
			})

			/* 이메일 인증번호 전송 */
			var code = "@sdjwiqwhkql;asdfqjw!"; //이메일전송 인증번호 저장위한 코드
			$("#sendEmail").click(function () {
				var warnMsg = $(".mail_input_box_warn");
				var email = $("#inputEmail").val(); // 입력한 이메일

				if (mailFormCheck(email)) {
					warnMsg.html("이메일이 전송 되었습니다. 이메일을 확인해주세요.");
					warnMsg.css("display", "inline-block");
				} else {
					warnMsg.html("올바르지 못한 이메일 형식입니다.");
					warnMsg.css("display", "inline-block");
					return false;
				}
				$.ajax({
					type: "GET",
					url: "mailCheck?email=" + email,
					success: function (data) {
						code = data;
						$("#sendEmail").attr('disabled', 'disabled');
					},
					error: function () {
						alert("서버 요청 실패");
					}
				});
			});

			//이메일 형식 검사 메소드
			function mailFormCheck(email) {
				var form = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
				return form.test(email);
			}

			/* 인증번호 비교 */
			$("#inputEmailChk").keyup(function () {
				var inputCode = $("#inputEmailChk").val();
				var checkResult = $("#email_feedback");
				if (inputCode == code) { // 일치할 경우
					checkResult.html("인증번호가 일치합니다.");
					checkResult.attr('color', '#2fb380');
					checkResult.attr('value', '0');
				} else { // 일치하지 않을 경우
					checkResult.html("인증번호를 다시 확인해주세요.");
					checkResult.attr('color', '#dc3545');
					checkResult.attr('value', '1');
				}
			});

			/* 자격증추가 */
			/* 자격증 진위확인 api사용 */
			$("#qPlus").click(function () {
				var name = $("#inputName").val();
				var qNo = $("#inputQno").val();
				var qNa = $("#inputQna").val();
				var certType = $('input:radio[name="certType"]:checked').val();
				var qName = "";
				$.ajax({
					url: `qualCheck?no=${qNo}&name=${name}`,
					dataType: "json",
					success: function (result) {
						if (result.result == false) {
							qName = qNa;
							/* li 만들고 append */
							$("#qList").append($("<li/>").attr('class', 'qualLi').append(
								$("<span/>").attr('data-value', '{\"crtfName\":\"' + qName + '\",\"crtfNum\":\"' +
									qNo + '\",\"crtfType\":\"' + certType + '\"}').text("자격증: " + qName +
									" | 자격증발급번호: " + qNo),
								$("<button/>").attr({
									type: "button",
									class: "quDelBtn"
								}).text("X").on('click', function () {
									$(this).parentsUntil('#qList').remove(); //삭제버튼 추가
								})
							))
						} else {
							alert('확인되지 않는 자격증입니다.')
						}
					},
					error: function () {
						alert("서버 요청 실패");
					}
				})
			});

			$('.quDelBtn').click(function () {
				$(this).parentsUntil('#qList').remove();
				console.log($(".qualLi").eq(0).children().eq(0).data('value'));
			});

			//유효성 최종 검사 후 회원가입 처리
			$("#normalSignIn").click(function () {
				var idCheck = $("#id_feedback").attr('value');
				var pwCheck = $("#pw_feedback").attr('value');
				var pwcCheck = $("#pwc_feedback").attr('value');
				var phone = $("#inputPhone").attr('value');
				var accnt = $("#inputAccnt").attr('value');
				var emailCheck = $("#email_feedback").attr('value');
				var name = $("#inputName").val();

				if (idCheck == 1) {
					alert("아이디 중복체크 검사는 필수입니다.");
				} else if (pwCheck == 1) {
					alert("비밀번호와 비밀번호확인 값이 다릅니다.");
				} else if (pwcCheck == 1) {
					alert("비밀번호를 확인해주세요.");
				} else if (emailCheck == 1) {
					alert("이메일 인증 절차를 진행해 주세요.");
				} else if (name == "") {
					alert("이름을 입력해 주세요.");
				} else if (phone == "") {
					alert("전화번호를 입력해 주세요.");
				} else if (accnt == "") {
					alert("계좌번호를 입력해 주세요.");
				} else {
					signIn(); //회원가입 함수 실행
				}
			});

			//회원가입 함수
			function signIn() {
				var qualLi = $(".qualLi");
				var qualArray = [];
				for (var i = 0; i < qualLi.length; i++) {
					qualArray.push(qualLi.eq(i).children().eq(0).data('value'));
				}
				var data = $('form[name="signIn"]').serializeObject();
				data.crtfs = qualArray;
				$.ajax({
					url: "/insertMember",
					method: "post",
					contentType: 'application/json',
					data: JSON.stringify(data),
					beforeSend: function (xhr) {
						xhr.setRequestHeader(header, token);
					},
					success: function (result) {
						$("#modal").show();
					},
					error: function () {
						alert("서버 요청 실패");
					}
				});
			}
		</script>
	</div>
</body>

</html>