<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default_layout}">
<head>
<!-- 1.사이드바 css적용 -->
<link rel="stylesheet" href="/css/myPageSide.css">
<meta charset="UTF-8">
<title>Insert title here</title>
<style>

#user {
	padding-top: 70px;
	width: 800px;
	margin: 0 auto;
}

.busiArea {
	width: 30px;
	margin: 0;
	display: block;
}

#chkArea {
	width: 530px;
	display: flex;
	justify-content: space-evenly;
}

.chkArea {
	width: 115px;
	height: 200px;
	overflow: scroll;
	border: 0.3px solid black;
	line-height: 1.5em;
}
</style>
</head>
<body>
	<div layout:fragment="content" class="content">
		<section class="module bg-dark-60 gallery-page-header parallax-bg" data-background="/assets/images/gallery_bg.jpg" style="background-image: url(&quot;assets/images/gallery_bg.jpg&quot;);">
          <div class="container">
            <div class="row">
              <div class="col-sm-6 col-sm-offset-3">
                <h2 class="module-title font-alt">마이페이지</h2>
                <div class="module-subtitle font-serif">회원정보 수정</div>
              </div>
            </div>
          </div>
        </section>
		
		<div style="min-height: 700px">
			<!-- 3.현재페이지 myPageSide 적용 -->
			<th:block th:replace="fragments/myPageSide :: myPageSide"></th:block>
			
			<div id="user">
			<ul>
				<li th:text="|가입일: ${#dates.format(user.userRegDate, 'yyyy년 MM월 dd일')}|"></li>
				<!-- 회원등급 -->
				<li th:if="${user.auth} == 'ROLE_ADMIN'" ><label>회원등급:</label><input type="text" disabled="disabled" value="관리자"></li>
				<li th:if="${user.auth} == 'ROLE_MEM'" ><label>회원등급:</label><input type="text" disabled="disabled" value="회원1"></li>
				<li th:if="${user.auth} == 'ROLE_MEMBER'" ><label>회원등급:</label><input type="text" disabled="disabled" value="회원2"></li>
				<li th:if="${user.auth} == 'ROLE_BUSI'" ><label>회원등급:</label><input type="text" disabled="disabled" value="업체"></li>
				
				<li><label>아이디:</label><input type="text" readonly="readonly" th:value="${user.userId}"></li>
				<li><label>이메일:</label><input id="userEmail" name="userEmail" type="text" th:value="${user.userEmail}"></li>
				<li><label>성 명:</label><input type="text" id="userName" name="userName"  th:value="${user.name}"></li>
				<li><label>연락처:</label><input id="userPhone" name="userPhone" type="text" th:value="${user.userPhone}"></li>
			
				<!-- 수신여부 -->
				<li>
					수신여부:
					<span><input th:attr="checked=${user.userMessaging} == 'S0'?'true' : 'false'" type="radio" name="userMessaging" value="S0" >수신거부</span>
					<span><input th:attr="checked=${user.userMessaging} == 'S1'?'true' : 'false'" type="radio" name="userMessaging" value="S1">메일</span>
					<span><input th:attr="checked=${user.userMessaging} == 'S2'?'true' : 'false'" type="radio" name="userMessaging" value="S2">휴대폰</span>
					<span><input th:attr="checked=${user.userMessaging} == 'S3'?'true' : 'false'" type="radio" name="userMessaging" value="S3">메일,휴대폰</span>
				</li>

				<!-- 회원계좌번호 -->
				<li>
					<label>예금주:</label><input id="depotr" name="depotr"  type="text" th:value="${user.depotr}">
				</li>
				<li>
					<label>은행사:</label>
							<select id="bank" name="bank" >
								<option value="" >=== 은행코드 ====</option>
								<option value="004" th:checked="${user.bank eq '004'}">국민은행</option>
								<option value="003" th:checked="${user.bank eq '003'}">기업은행</option>
								<option value="011" th:checked="${user.bank eq '011'}">농협은행</option>
								<option value="031" th:checked="${user.bank eq '031'}">대구은행</option>
							</select>
					
				</li>
				<li>
					<label>계좌번호:</label>
					<input id="accnt" name="accnt" type="text" th:value="${user.accnt}">
				</li>
			</ul>
				
				<th:block th:if="${user.busiNum} != null">
				<ul>
					<li><label>사업자번호:</label><input id="busiNum" name="busiNum" type="text" th:value="${user.busiNum}|" readonly="readonly"></li>
					<li><label>사업자명:</label><input id="busiTitle" name="busiTitle" type="text" th:value="${user.busiTitle}|"></li>
					
					<li><label>업체유형</label>
						<input type="radio" name="busiType" value="U1" th:checked="${user.busiType eq '기획'}"><label>기획업체</label> 
						<input type="radio" name="busiType" value="U2" th:checked="${user.busiType eq '렌탈'}"><label>렌탈업체</label>
					</li>
 					
 					<li>
 						<label>행사지역:</label><input id="busiArea" name="busiArea" type="text" th:value="|${user.busiArea}|">
 						<button type="button" id="areaUpdate" class="updateBtn">변경</button>
 					</li>
 					
					<li>
						<label>행사정보:</label><input id="busiStyle" name="busiStyle" type="text" th:value="|${user.busiStyle}|">
						<button type="button" id="styleaUpdate" class="updateBtn">변경</button>
					</li>
				</ul>
				</th:block>
				
					
					
				<!-- 적용해야됌 -->
				<div id="chkArea" >
		 			<div>
						행사가능지역
						<div class="chkArea" id="areaCheck">
							<div th:each="area : ${busiArea}">
								<input type="checkbox" th:id="${area.codeId}" th:value="${area.codeId}"
									name="busiArea"> <label th:text="${area.codeName}"
									th:for="${area.codeId}"></label>
							</div>
						</div>
					</div>
					<div>
						행사유형
						<div class="chkArea" id="styleCheck">
							<div th:each="type : ${busiStyle}">
								<input type="checkbox" th:id="${type.codeId}" th:value="${type.codeId}"
									name="busiStyle"> <label th:text="${type.codeName}"
									th:for="${type.codeId}"></label>
							</div>
						</div>
					</div>
				</div> 

				<button type="button" id="update">회원정보 수정</button>
			</div>
		<script>
		let userId = '[[${session.member != null ? session.member.userId :''}]]';
		var token = $("meta[name='_csrf']").attr("content");
		var header = $("meta[name='_csrf_header']").attr("content");
		
		//숨기기
		$('#chkArea').hide(); 
		
		//보여주기
		$('.updateBtn').on("click", function(){
			$('#chkArea').show();
		});
		
		$('#test').on("click", function(){
		var busiAreaArr = [];
		var busiStyleArr = [];
		let areaChecked = $('input:checkbox[name="busiArea"]:checked');
		let styleChecked = $('input:checkbox[name="busiStyle"]:checked');
		for (var i = 0; i < areaChecked.length; i++) {
			busiAreaArr.push(areaChecked.eq(i).val())
		}
		for (var i = 0; i < styleChecked.length; i++) {
			busiStyleArr.push(styleChecked.eq(i).val())
		}
		var busiArea = busiAreaArr.toString();
		var busiStyle = busiStyleArr.toString();
		
		})
		
		//수정하기 버튼 누를시
		$('#update').on("click", function() {

			//일반회원 정보
			let userId = '[[${session.member != null ? session.member.userId :''}]]';
			let userEmail = $('#userEmail').val();
			let name = $('#userName').val();
			let userPhone = $('#userPhone').val();
			let userMessaging = $('input[name="userMessaging"]:checked').val(); 
			let depotr = $('#depotr').val();
			let bank = $("select[name=bank]").val();
			let accnt =$('#accnt').val();
			
			//업체 추가정보
		 	let busiTitle = $('#busiTitle').val();
			let busiType = $('input:radio[name="busiType"]:checked').val();
			var busiAreaArr = [];
			var busiStyleArr = [];
			let areaChecked = $('input:checkbox[name="busiArea"]:checked');
			let styleChecked = $('input:checkbox[name="busiStyle"]:checked');
			for (var i = 0; i < areaChecked.length; i++) {
				busiAreaArr.push(areaChecked.eq(i).val())
			}
			for (var i = 0; i < styleChecked.length; i++) {
				busiStyleArr.push(styleChecked.eq(i).val())
			}
			var busiArea = busiAreaArr.toString();
			var busiStyle = busiStyleArr.toString();
			var busi = {
				"busiTitle": busiTitle,
				"busiType": busiType,
				"busiArea": busiArea,
				"busiStyle": busiStyle,
				"userId":userId,
			};
			console.log(busiTitle)
			console.log(busiType)
			console.log(busiAreaArr)
			console.log(busiStyleArr);
		
			
		$.ajax({
 	   			url : '/myPage/userUpdate',
 	   			method : 'post',
 	   			dataType: "json",
	            data: JSON.stringify({userId,userEmail,name,userPhone,userMessaging,depotr,bank,accnt,busi}),
	            contentType : "application/json",
 	   			beforeSend : function(xhr)
 	            {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
 					xhr.setRequestHeader(header, token);
 	            },
				success : function(result){
					console.log(result);
			      if(result > 0){
						alert('수정완료')
						location.href='/myPage/userMypage'; 
			     }else {
						alert('수정실패')	
			     }
				 },
		        fail: function () {
		           }
				})
		})
		
			
		</script>
		
		
		</div>
	</div>
</body>
</html>