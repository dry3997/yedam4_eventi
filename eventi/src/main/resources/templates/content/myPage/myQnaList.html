<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default_layout}">
<head>
<!-- 1.사이드바 css적용 -->
<link rel="stylesheet" href="/css/myPageSide.css">
<!-- 모달 스타일 -->
<link rel="stylesheet" href="/css/model.css">
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<!-- 2.레이아웃 content적용 -->
	<div layout:fragment="content" class="content">

		<section class="module bg-dark-60 gallery-page-header parallax-bg"
			data-background="/assets/images/gallery_bg.jpg"
			style="background-image: url(&quot;assets/images/gallery_bg.jpg&quot;);">
			<div class="container">
				<div class="row">
					<div class="col-sm-6 col-sm-offset-3">
						<h2 class="module-title font-alt">마이페이지</h2>
						<div class="module-subtitle font-serif">공모전 문의리스트</div>
					</div>
				</div>
			</div>
		</section>


		<div style="min-height: 700px">
			<!-- 3.현재페이지 myPageSide 적용 -->
			<th:block th:replace="fragments/myPageSide :: myPageSide"></th:block>

			<!-- 게시글 검색 -->
			<form name="searchFrm">
				<input type="hidden" name="page" value="1">
			</form>

			
		 	<!-- 문의내역이 없을경우 -->
		 	<div th:if="${#lists.isEmpty(qnaList)}">
				<h3>문의내역이 없습니다.</h3>
			</div>	
		 	
		 	<!-- 문의내역이 있을경우 -->
		 	<div th:if="${!#lists.isEmpty(qnaList)}">
				<!-- 테이블 -->
				<div id="table">
					<table border="1" id="myTable">
						<thead>
							<tr>
								<th>문의No</th>
								<th>게시글No</th>
								<th>문의사항제목</th>
								<th>작성일자</th>
								<th>답변유무</th>
								<th>조회</th>
							</tr>
						</thead>
						<tbody>
							<!-- 답변이아닌 문의내용만 출력할것.. -->
							<tr th:each="q : ${qnaList}" >
								<td th:text=${q.qNo}></td>
								<td th:text=${q.targetId}></td>
								<td th:text=${q.ttl}></td>
								<td th:text="|${#dates.format(q.writingDt, 'yyyy-MM-dd')}"></td>
								<td th:text=${q.ans}></td>
								<td><button type="button" class="select">조회</button></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			
			<!-- 페이징처리  -->
			<div class="row mt-5">
				<div class="col text-center">
					<div class="block-27">
						<th:block
							th:replace="fragments/paging :: component(${paging},'gopage')">
					</div>
				</div>
			</div>
			
		<!--문의내역 상세보기 -->
		<div id="qnaModal" class="modal">
			<!-- Modal content -->
			<div class="modal-content">
				<span class="close">&times;</span>
				<h3 style="text-align: center;">문의내역</h3>
				<div id="qna"></div>
				<div id="qnaRep"></div>
			</div>
		</div>
			
			
		</div>
		<script>
		//csrf 설정
		var token = $("meta[name='_csrf']").attr("content");
		var header = $("meta[name='_csrf_header']").attr("content");

		//페이징 
		function gopage(i) {
			searchFrm.page.value = i;
			searchFrm.submit();
		}
		
		//모달창-----------------------------------------------------------
		// Get the modal
		var qnaModal = document.getElementById("qnaModal");

		// Get the <span> element that closes the modal
		var span = document.getElementsByClassName("close")[0];
		
		// 모달창 띄우기.
		// 마감연장일이 이미 지정된 경우 모달창 띄우지 않도록.
		$('.select').on("click", function(){ 
			qnaModal.style.display = "block";
		})
		// When the user clicks on <span> (x), close the modal
		span.onclick = function() {
			qnaModal.style.display = "none";
		}
		
		// When the user clicks anywhere outside of the modal, close it
		window.onclick = function(event) {
		  if (event.target == qnaModal) {
			  qnaModal.style.display = "none";
		  }
		}
		
		$('.select').on("click", function(){
			let qNo = $(this).parent().parent().children('td:eq(0)').text();
			
			$.ajax({
	            url:"/questions/queDetailAjax",
	            method:"post",
	            data : {qNo},
	            beforeSend : function(xhr)
                {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
    				xhr.setRequestHeader(header, token);
                },
			}).then(res => {
				console.log(res);
				$('#qna').empty();
				$('#qnaRep').empty();
				
				$('#qna').append(make(res[0]));
					if(res[1] !=null && res[1].rerepTgt != null){ 
						$('#qnaRep').append(makeRep(res[1]));
					}					
				})
	        })
			
		
		//문의사항 생성
		function make(data){
			let ul = `  <h4>${data.ttl}</h4>
						<ul>
								<li>${data.cntn}</li>
								<li></li>
						</ul>
					`;
			return ul;
		} 
		
		//문의답변 생성
		function makeRep(data){
			let ul = `  <h4>답변내용</h4>
						<ul>
								<li>${data.cntn}</li>
								<li></li>
						</ul>
					`;
			return ul;
		} 
		
		//답변이있다면
			
		</script>
	</div>
</body>
</html>