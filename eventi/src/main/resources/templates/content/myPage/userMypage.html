<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default_layout}">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="/css/myPageSide.css">
<link rel="stylesheet" href="/css/contest/model.css">
<link rel="stylesheet" href="/css/contest/button.css">
<style>
#user {
	padding-top: 70px;
	width: 800px;
	margin: 0 auto;
	margin-bottom: 60px;
}
p{
	margin-bottom: 20px;
	font-size: 18px;
}
</style>
</head>
<body>
	<div layout:fragment="content" class="content">
		<section class="module bg-dark-60 gallery-page-header parallax-bg"
			data-background="/assets/images/gallery_bg.jpg"
			style="background-image: url(&quot;assets/images/gallery_bg.jpg&quot;);">
			<div class="container">
				<div class="row">
					<div class="col-sm-6 col-sm-offset-3">
						<h2 class="module-title font-alt">마이페이지</h2>
						<div class="module-subtitle font-serif">회원정보 조회</div>
					</div>
				</div>
			</div>
		</section>

		<div style="min-height: 700px">
			<!-- 3.현재페이지 myPageSide 적용 -->
			<th:block th:replace="fragments/myPageSide :: myPageSide"></th:block>


			<div id="user">
				<p th:text="|아이디: ${user.userId}|"></p>
				<p th:text="|이메일:${user.userEmail}|"></p>
				<p th:text="|성 명:${user.name}|"></p>
				<p th:text="|연락처:${user.userPhone}|"></p>

				<!-- 수신여부 -->
				<div th:if="${user.userMessaging} == 'S0'">
					<p th:text="|수신여부: 받지않음|"></p>
				</div>
				<div th:if="${user.userMessaging} == 'S1'">
					<p th:text="|수신여부: 메일|"></p>
				</div>
				<div th:if="${user.userMessaging} == 'S2'">
					<p th:text="|수신여부: 휴대폰|"></p>
				</div>
				<div th:if="${user.userMessaging} == 'S3'">
					<p th:text="|수신여부: 메일,휴대폰|"></p>
				</div>

				<!-- 회원등급 -->
				<div th:if="${user.auth} == 'ROLE_ADMIN'">
					<p th:text="|회원등급: 관리자|"></p>
				</div>
				<div th:if="${user.auth} == 'ROLE_MEM'">
					<p th:text="|회원등급: 회원?|"></p>
				</div>
				<div th:if="${user.auth} == 'ROLE_MEMBER'">
					<p th:text="|회원등급: 회원|"></p>
				</div>
				<div th:if="${user.auth} == 'ROLE_BUSI'">
					<p th:text="|회원등급: 업체|"></p>
				</div>


				<div th:if="${user.accnt} != null">
					<p th:text="|예금주:${user.depotr}|"></p>
					<p th:text="|은행사:${user.bank}|"></p>
					<p th:text="|계좌번호:${user.accnt}|"></p>
				</div>
				
				<div th:if="${user.depotr} == null">
					<p>예금주:</p>
					<p>은행사:</p>
					<p>계좌번호:</p>
				</div>
				
				<div th:if="${user.busiNum} != null">
					<p th:text="|사업자번호 : ${user.busiNum}|"></p>
					<p th:text="|상호명: ${user.busiTitle}|"></p>
					<p th:text="|업종:${user.busiType}|"></p>
					<p th:text="|행사지역:${user.busiArea}|"></p>
					<p th:text="|행사유형:${user.busiStyle}|"></p>
				</div>
				
				
				
				<p th:text="|가입일: ${#dates.format(user.userRegDate, 'yyyy년MM월dd일')}|"></p>

				<button type="button" id="update">수정</button>
				<button type="button" id="delete">탈퇴</button>
			</div>
		</div>

		<!-- 비밀번호 확인창. -->
		<div id="myModal" class="modal">
			<div class="modal_content">
				<span class="close">&times;</span>
				<h3>비밀번호 확인</h3>
				<label>비밀번호</label><input type="text" id="password" name="userPassword" required="required"><br>
				<label>비밀번호확인</label><input type="text" id="passwordchk" name="passwordchk" required="required"><br>
				<font id="pw_feedback" size="2" value="1"></font>
				<div id="checkDiv">
					<button id="check" class="modelBtn1" style="width: 50px;" type="button">확인</button>
				</div>
			</div>
		</div>


		<script>
			let userId = '[[${session.member != null ? session.member.userId :''}]]';
			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
		
			var password = $("#pw_feedback").attr('value');
			var passwordchk = $("#pw_feedback").attr('value');
			//모달창-----------------------------------------------------------
			// Get the modal
			var modal = document.getElementById("myModal");

			// Get the <span> element that closes the modal
			var span = document.getElementsByClassName("close")[0];

			// When the user clicks on <span> (x), close the modal
			span.onclick = function() {
				modal.style.display = "none";
				$('#password').val('');
				$('#passwordchk').val('');
				$("#pw_feedback").html('');
			}

			// When the user clicks anywhere outside of the modal, close it
			window.onclick = function(event) {
				if (event.target == modal) {
					modal.style.display = "none";
				}
			}
			

			//수정하기 버튼 누를시
			$('#update').on("click", function() {
				if (!confirm('회원정보를 수정하시겠습니까?')) {
					return false;
				}
				else {
					$('#checkDiv').children('#check').attr('id' , "update")
					// 모달창 띄우기.
					modal.style.display = "block";
					
					//비번 중복체크
					$('#passwordchk').keyup(function () {
						let password = $('#password').val();
						let passwordChk =  $('#passwordchk').val();
						if (password == passwordChk) {
							$("#pw_feedback").html('비밀번호가 일치합니다.');
							$("#pw_feedback").attr('color', '#2fb380');
							$("#pw_feedback").attr('value', '0');
							
						} else {
							$("#pw_feedback").html('비밀번호가 일치하지 않습니다.');
							$("#pw_feedback").attr('color', '#dc3545');
							$("#pw_feedback").attr('value', '1');
						}
					})
				 $('#checkDiv').children('#update').on("click", updateForm);
				}
			})

			
			function updateForm() {
				$('#checkDiv').children('#update').attr('id' , "check")
				modal.style.display = "none";
				let password = $('#password').val();
				
				$.ajax({
	 	   			url : '/myPage/userPwCheck',
	 	   			method : 'post',
	 	   			data : {userId,userPassword:password},
	 	   			beforeSend : function(xhr)
	 	            {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
	 					xhr.setRequestHeader(header, token);
	 	            }
	 	   			,success : function(result){
	 	   			      if(result == true){
	 	   			    	location.href='/myPage/userUpdateForm'; 
	 	   			     }else {
	 	   						alert('비밀번호가 일치하지 않습니다.')	
	 	   			     }
	 	   			}
	 	   			,fail: function () {
	 	   					alert('요청실패')	
	 	   		         }
	 	   			})
			}
			
			//탈퇴누를경우 update 권한수정
			$('#delete').on("click", function() {
				if (!confirm('탈퇴하시겠습니까?')) {
					return false;
				}
				else {
					$('#checkDiv').children('#check').attr('id' , "delete")
					// 모달창 띄우기.
					modal.style.display = "block";
					
					//비번 중복체크
					$('#passwordchk').keyup(function () {
						let password = $('#password').val();
						let passwordChk =  $('#passwordchk').val();
						if (password == passwordChk) {
							$("#pw_feedback").html('비밀번호가 일치합니다.');
							$("#pw_feedback").attr('color', '#2fb380');
							$("#pw_feedback").attr('value', '0');
							
						} else {
							$("#pw_feedback").html('비밀번호가 일치하지 않습니다.');
							$("#pw_feedback").attr('color', '#dc3545');
							$("#pw_feedback").attr('value', '1');
						}
					})
				$('#checkDiv').children('#delete').on("click",userdelete);
				}
			})
			
			function userdelete(){
				$('#checkDiv').children('#delete').attr('id' , "check")
				modal.style.display = "none";
				
			$.ajax({
 	   			url : '/myPage/userStateUpdate',
 	   			method : 'post',
 	   			data : {userId,userState:'leave'},
 	   			beforeSend : function(xhr)
 	            {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
 					xhr.setRequestHeader(header, token);
 	            },
				success : function(result){
				      if(result > 0){
							alert('회원탈퇴 완료')
							$('.nav').children('li:eq(11)').children('form').submit();
				     }else {
							alert('회원탈퇴 실패')	
				     }
				 },
		        fail: function () {
		           }
				})
			}
		</script>
	</div>
</body>
</html>