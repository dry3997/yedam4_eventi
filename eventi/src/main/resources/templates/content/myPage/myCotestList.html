<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default_layout}">
<head>
<!-- 1.사이드바 css적용 -->
<link rel="stylesheet" href="/css/myPageSide.css">
<link rel="stylesheet" href="/css/contest/button.css"> 
</head>
<body>

	<!-- 2.레이아웃 content적용 -->
	<div layout:fragment="content" class="content">
	<h2 hidden="hidden" class="module-title font-alt">공모전리스트</h2>
		
		<!-- 3.현재페이지 myPageSide 적용 -->
		<th:block th:replace="fragments/myPageSide :: myPageSide"></th:block>

		<div class="contest" >
		<!-- 리스트 값이 없을경우 -->
		<div th:if="${#lists.isEmpty(contestList)}">	
			<h3>등록한 공모전이 없습니다.</h3>
		</div>
		
		<div th:if="${!#lists.isEmpty(contestList)}">	
		<!-- 게시글 검색 -->
			<form name="searchFrm">
				<label>제목</label><input type="text" name="ttl" value="">
				<label>내용</label><input type="text" name="cntn" value="">
				<input type="hidden" name="page" value="1">
				<button type="submit" id="searchBtn" class="btn btn-g btn-round inputBtn">검색</button>
				<button type="button" id="deleteBtn"  class="btn btn-d btn-round delBtn">삭제</button>
			</form>
			
			
			<!-- 테이블 -->
			<table id="table">
				<thead>
					<tr>
						<th><input type="checkBox" value="삭제" class="delete" id="allDelete"></th>
						<th>no</th>
						<th>분류별</th>
						<th style="width:30%;">제목</th>
						<th style="width:30%;">진행기간</th>
						<th>진행</th>
						<th>지원수</th>
						<th>디자인조회</th>
						<th>상세조회</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="contest : ${contestList} ">
						<td><input class="check delete" type="checkBox" value="delete" onkeyup="myFunction()"></td>
						
						<td th:text=${contest.cNo}></td>
						<td th:text=${contest.category}></td>
						<td th:text=${contest.ttl}></td>
						
						<!-- 마감기한만 있을경우 -->
						<th:block th:if="${contest.dtExtns} == null">
							<td th:text="|${#dates.format(contest.dtReg, 'yyyy-MM-dd')} ~ ${#dates.format(contest.dtCls, 'yyyy-MM-dd')}"></td>
						</th:block>
						
						<!-- 마감연장 1회 한경우 -->
						<th:block th:if="${contest.dtExtns} != null">
							<td th:text="|${#dates.format(contest.dtReg, 'yyyy-MM-dd')} ~ ${#dates.format(contest.dtExtns, 'yyyy-MM-dd')}"></td>
						</th:block>
						
						<!-- 임시저장 한경우 -->
						<th:block th:if="${contest.ing} eq '임시저장'">
							<td th:text="${contest.ing}"></td>
							<td th:text="${contest.designCount}"></td>
							<td></td>
							<td><button class="btn btn-g btn-round" type="button" id="selete" th:onclick="|location.href='@{insert(cNo=${contest.cNo})}'|">공모전등록</button></td>
						</th:block>
						
						<!-- 공모전 등록한 경우 -->
						<th:block th:if="${contest.ing} == '마감'">
							<th:block th:if="${contest.winnerCheck} == 0 and ${contest.designCount} == 0">
								<td th:text="${contest.ing}"></td>
								<td th:text="${contest.designCount}"></td>
								<td></td>
							</th:block>
							<th:block th:if="${contest.winnerCheck} == 0 and ${contest.designCount} > 0">
								<td th:text="${contest.ing}"></td>
								<td th:text="${contest.designCount}"></td>
								<td><button class="btn btn-g btn-round" type="button" id="selete" th:onclick="|location.href='@{/contest/designRead(cNo=${contest.cNo})}'|">우승자등록</button></td>
							</th:block>
							<th:block th:if="${contest.winnerCheck} > 0">
								<td th:text="종료"></td>
								<td th:text="${contest.designCount}"></td>
								<td></td>
							</th:block>
							<td><button class="btn btn-g btn-round" type="button" th:onclick="|location.href='@{select(cNo=${contest.cNo})}'|">상세조회</button></td>
							<td></td>
						</th:block>
						
						<th:block th:if="${contest.ing} == '진행'">
							<td th:text="${contest.ing}"></td>
							<td th:text="${contest.designCount}"></td>
						
							<th:block th:if=" ${contest.designCount} > 0 " >
								<td><button class="btn btn-g btn-round" type="button"  id="selete" th:onclick="|location.href='@{/contest/designRead(cNo=${contest.cNo})}'|">지원자조회</button></td>
							</th:block>
							<th:block th:if=" ${contest.designCount} == 0 " >
								<td></td>
							</th:block>
								<td><button class="btn btn-g btn-round" type="button" th:onclick="|location.href='@{select(cNo=${contest.cNo})}'|">상세조회</button></td>
						</th:block>
						
							
						
						
						
					</tr>
				</tbody>
			</table>
	
			<!-- 페이징처리 -->
			<div class="row mt-5">
				<div class="col text-center">
					<div class="block-27">
						<th:block
							th:replace="fragments/paging :: component(${paging},'gopage')">
					</div>
				</div>
			</div>
		</div>
		
		</div>


		<script>
		
		//페이지이동 및 검색
		//페이징개수 변환 myContest 동적쿼리
		function gopage(i) {
			//내용초기화
			$('input[name="ttl"]').val('');
			$('input[name="cntn"]').val('');
			searchFrm.page.value = i;
			searchFrm.submit();
		 }
		
		var token = $("meta[name='_csrf']").attr("content");
		var header = $("meta[name='_csrf_header']").attr("content");

		// tr 전체체크시 모든항목 체크되도록 
		let allDelete = document.querySelector("#allDelete")
		let deleteCheck = document.querySelector(".delete")
		allDelete.addEventListener('change', function () {
			//forEach 반복문사용.
			document.querySelectorAll('input[value="delete"]').forEach( function (deleteCheck) {
					deleteCheck.checked = allDelete.checked;
			})
		})
		

		//공모전 삭제
		document.querySelector('#deleteBtn').addEventListener('click', deleteContest);
		
		function deleteContest(deleteCheck) {
			let trs = document.querySelectorAll('table>tbody>tr');

			if (!confirm('공모전을 삭제하시겠습니까?')) {
				return false;
			} else {
				for (let i = 0; i < trs.length; i++) {
					if (trs[i].children[0].children[0].checked) {
						
						let cNo = trs[i].children[1].textContent; //체크된 공모번호

						//삭제처리 ajax
						$.ajax({
							url: '/contest/delete',
							method: "post",
							data: {cNo},
							beforeSend: function (xhr) {
								/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
								xhr.setRequestHeader(header, token);
							},
						}).then(res => {
							if (res == 1) {
								trs[i].remove(); // tr 화면동적 삭제
								alert('삭제 완료');
							} else {
								alert('응모작품이 있어 삭제 불가능합니다.');
							}
						})
					}
				}
			}
		}
		
	</script>
	</div>
</body>
</html>