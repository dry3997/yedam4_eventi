<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default_layout}"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">>
<head>
<link rel="stylesheet" href="/css/heart.css">
<link rel="stylesheet" href="/css/contest/button.css"><!--버튼 스타일 -->
<style>
	.col-md-4{
    top: -50px !important;
	margin-bottom: -90px !important;
	}
	
	<!--디자인 상세보기 모달-->
	.modal {
		display: none; /* Hidden by default */
		position: fixed; /* Stay in place */
		z-index: -1; /* Sit on top */
		padding-top: 100px; /* Location of the box */
		left: 0;
		top: 0;
		width: 100%; /* Full width */
		height: 100%; /* Full height */
	 	overflow: auto; /* Enable scroll if needed */ 
		background-color: rgba(0, 0, 0, 0.5); /* Black w/ opacity */
		box-sizing: border-box;
	}
	
	.img_modal_content {
		background-color: #fefefe;
		margin : 70px auto;
		border: 1px solid #888;
		width: 70%;
		height: 90%;
		text-align: left;
		
		/* 이미지 스크롤*/
		max-height: calc(100vh - 210px);
	    overflow-y: auto;
	}
	
	/* 스크롤바 지우기 */
	.img_modal_content::-webkit-scrollbar {
	    display: none; /* 크롬, 사파리, 오페라, 엣지 */
	}
	
	.close {
		color: black;
		float: right;
		font-size: 40px;
		font-weight: bold;
		text-align: right;
		margin-right: 10px;
	}
	
	.close:hover, .close:focus {
		color: #000;
		text-decoration: none;
		cursor: pointer;
	}
	
	#modelBtn {
		text-align: center;
	}
	
	.modelBtn1 {
		display: inline-block;
	}
	
	.modal_content {
		width: 350px;
		min-height: 200px;
		margin: 0 auto;
		padding: 20px;
		background: #fff;
		border: 0.5px solid #666;
		border-radius: 15px;
	}
	
	.modal_layer {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.5);
		z-index: -1;
	}
	
	/* Create three unequal columns that floats next to each other */
	.column {
	  float: left;
	  padding: 10px;
	}
	
	/* Left and right column */
	.column.side {
	  width: 30%;
	  height: 100%;
	  float: right;
	  position: sticky;
	  top: 0;
	  background-color: lightGray;
	  padding:20px;
	  
	}
	
	/* Middle column */
	.column.middle {
	  width: 70%;
	  padding:0;
	  
	}
	
	/* Responsive layout - makes the three columns stack on top of each other instead of next to each other */
	@media screen and (max-width: 600px) {
	  .column.side, .column.middle {
	    width: 100%;
	  }
	}
	
	.radius{
		width: 50px;
	    height: 50px; 
	    border-radius: 70%;
	    overflow: hidden;
	    margin:0;
	}
	
	.radius_img{
		width: 100%;
		height: 100%;
		object-fit:cover;
	}	
</style>
</head>   

<div layout:fragment="content">
	<section class="module bg-dark-60 gallery-page-header parallax-bg" data-background="/assets/images/gallery_bg.jpg" style="background-image: url(&quot;assets/images/gallery_bg.jpg&quot;);">
         <div class="container">
           <div class="row">
             <div class="col-sm-6 col-sm-offset-3">
               <h2 class="module-title font-alt">디자인</h2>
               <div class="module-subtitle font-serif">전체리스트</div>
             </div>
           </div>
         </div>
     </section>
     
		<!-- 페이징/정렬처리 -->
		<form id="designFrm" name="designFrm">
			<label>제목</label><input type="text" name="name" value="">
			<label>내용</label><input type="text" name="cntn" value="">
			<input type="hidden" name="page" value="1">
			<button type="submit" class="btn btn-g btn-round inputBtn">검색</button>
		</form>
		
		<!-- 좋아요리스트 조회 및 공모전 작성 버튼 -->
		<div class="col-sm-3 mb-sm-20"  style="position:relative; top:-25px; right:10px; width: 100px;">
			<!-- 비회원 좋아요버튼-->
			<th:block sec:authorize="!isAuthenticated()">
					<div id="love" class="stage heart" th:onclick="|location.href='@{/loginPage}'|"></div>
			</th:block>
			
			<!-- 회원 좋아요버튼-->
			<th:block sec:authorize="isAuthenticated()">
					<div id="love" class="stage heart" onclick="likeClick(this)"></div>
			</th:block>
		</div>
	
		<!-- 디자인 리스트 반복 실행 -->
	<div class="container">
			<div class="row multi-columns-row" id="designBox">
				<div th:each="d : ${designList}">
					
					<div class="col-sm-6 col-md-4 col-lg-4" > 
						<div class="shop-item">
							   <th:block th:if="${d.mylike} > 0">
									<div class="stage heart active" th:attr="onclick=|likeCheck(this,'${d.dgnNo}')|" style="position:relative; top:80px; z-index: 1;  right: -280px;">
									<img th:if="${d.winYn} == Y" th:src="@{/images/winner.png}" style="width: 30px; height: 30px; position:relative; top:37px; z-index: 1;  left: -300px;">
									</div>
								</th:block>
								
								<th:block th:if="${d.mylike} == 0">
									<div class="stage heart" th:attr="onclick=|likeCheck(this,'${d.dgnNo}')|" style="position:relative; top:80px; z-index: 1;  right: -280px;">
									<img th:if="${d.winYn} == Y" th:src="@{/images/winner.png}" style="width: 30px; height: 30px; position:relative; top:37px; z-index: 1;  left: -300px;">
									</div>
								</th:block>  
															
							<div class="shop-item-image">
							<img th:src="|/fileView/${d.centerImg}|" style="width: 360px; height: 400px;" class="img-fluid">
							    <div class="shop-item-detail">
								   			<h3 class="content-box-title font-serif" th:text="|[${d.caregory}]${d.dgnNo}|"></h3>
								   			<h3 class="content-box-title font-serif" th:text="|디자이너 : ${d.userId}|"></h3>
								   			<h3 th:id="${d.userId}" class="content-box-title font-serif" th:text="|제목: ${d.name}|"></h3>
							        <div class="btn btn-round btn-b">
							              <span th:id="${d.dgnNo}" class="icon-magnifying-glass" >상세보기</span>
						             </div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
	</div>
					
	
	<div class="row mt-5" id="paging">
         <div class="col text-center">
           <div class="block-27">
              <th:block th:replace="fragments/paging :: component(${paging},'gopage')">
           </div>
         </div>
    </div>	
    
   <!-- //페이징 경로 :: 문자 -->
	<div class="row mt-5" >
		<div class="col text-center">
			<div class="block-27" id="returnPaging">
			</div>
		</div>
	</div>
	

	<!-- 디자인 상세보기 모달 -->
	<div id="dseignModel" class="modal">
		<div class="img_modal_content">
			
			<div class="column middle">
				<h3 id="caregory">분류</h3>
				<h2 id="ttl">제목</h2>
				<div id="modelSelect"></div>
			</div>
			  
			<div class="column side">
			  	<span class="close">&times;</span>
			    <h3 id="dgnerSelect"></h3>
			</div>
			
		</div>
		<div class="modal_layer"></div>
	</div>
	

		
	<script>
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	
	//페이징 
	function gopage(i) {
		$('input[name="name"]').val('');
		$('input[name="cntn"]').val('');
		$("input[name='page']").val(i);
		
		//하트가 눌렸을 경우 실행
		if ($("#love").hasClass("active")) { 
			likeSelect();
		}else{
			$("#designFrm").submit();   
		}
	 }
	
	// Get the modal
	var designModel = document.getElementById("dseignModel");
	
	
	$('.close').on("click", function(){
		designModel.style.display = "none";
	})
	
	//DB좋아요 추가,삭제
	//하트클릭시 DB입력(등록,취소)
	function likeCheck(e,targetNo) {
		
		$(e).toggleClass("active");//css 변경
		let category = 'T09';
		
		//하트가 눌렸을 경우 실행
		if ($(e).hasClass("active")) {
			$.ajax({
				url: '/likes/lInsert',
				method: 'post',
				data: {targetNo,category},
				beforeSend: function (xhr) {
					/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
					xhr.setRequestHeader(header, token);
				},
			}).then(res => {
				if(res > 0){
					alert('관심 디자인 추가완료!')
						//전체하트가 눌려진 상태로 재실행
						if ($("#love").hasClass("active")) { 
							loveClick();
						//기본 정렬리스트 재실행
						}else{
							checkSelect();
						}
					
				}else{
					alert('관심 디자인 추가실패!')
				}
			})

			//하트가 눌리지 않았을 경우 실행
		} else if (!($(e).hasClass("active"))) {
			//하트가 눌렸을 경우 실행
				$.ajax({
					url: '/likes/lDelete',
					method: 'post',
					data: {targetNo,category}, 
					beforeSend: function (xhr) {
						/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
						xhr.setRequestHeader(header, token);
					}
				}).then(res => {
					if(res > 0){
						alert('관심 디자인 취소완료!')

						//전체하트가 눌려진 상태로 재실행
						if ($("#love").hasClass("active")) { 
							likeClick();
							
						//기본 정렬리스트 재실행
						}else{
							checkSelect();
						}
						
					}else{
						alert('관심 디자인 취소실패!')
					}
				})
			}
	}
	
	//디자인 공개여부 모달창---------------------------------------------------------------
	 $('#designBox').on("click", "span" ,function(e){
		let dNo = e.target.id
		let userId = e.target.parentElement.previousSibling.previousSibling.id
		console.log(userId);
		designModel.style.display = "block";
		
		$.ajax({
			url: '/design/ajaxSelect',
			method: 'post',
			data: {dgnNo:dNo, userId:userId},
			beforeSend: function (xhr) {
				/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
				xhr.setRequestHeader(header, token);
			},
		}).then(res => {
			console.log(res);
			
			let user = res.userId;
			let title = res.name;
			let cntn = '';
			let contest='';
			$('#designModel').empty();
			$('#dgnerSelect').empty();
			
			$('#ttl').text(title);
			$('#caregory').text(res.caregory);
			
			
			if(res.cNo != null){
				contest = `<a href="/contest/select?cNo=${res.cNo}">
					<button type="button">응시공모전 보기</button>
					</a>`
			}
			
			if(res.cntn != null){
				cntn = `<p><small>${res.cntn}</small></p>
							<hr>`
			}
			
			
			let content = ` <div class="radius">
							<img class="radius_img" src="/fileView/${res.mainimg}" style="width: 50px; height: 50px">
							</div>
							<h3><small>DESING BY</small> ${user}</h3>
							<h3><small>우승횟수 ${res.cnt}회</small></h3>
							
							<hr>
							${cntn}
							<a href="/prtfl/dgnerSelect?userId=${user}">
								<button type="button">${user}님의 포트폴리오 이동</button>
							</a>
							${contest}
						  `
			
			$('#dgnerSelect').append(content);
			
			//모달내용을 지운뒤 붙여넣기.
			for(file of res.files){
				console.log(file);
				
				$('#modelSelect').append(makeDesignModel(file.sevNm,title,dNo));
			}
			
		})
	}) 
	
	//모달창 :디자인 응모작품 생성.
	function makeDesignModel(fileName,title,dNo){
		let design = `  <div class="design" id="${dNo}" style="float: left ">
								<img src="/fileView/${fileName}" style="width: 900px; height: 900px">
					   </div>
					  `;
		return design;
	}
	//모달창 숨기기.
	$("#designCancel").on('click', function() {
		$("#designModel").hide();
	});
	
	//공모전 전체하트를 클릭했을 경우 => 나의 좋아요 공모전박스 생성출력.
	function likeClick(e) {
		$('input[name=page]').val(1);
		$(e).toggleClass("active"); 
		likeSelect();
	}

	function likeSelect(){
		let page = $('input[name=page]').val();
		
		if ($("#love").hasClass("active")) { //하트가 눌렸을 경우 실행

			$.ajax({
				url: '/design/ajaxlike',
				method: 'post',
				data:{page},
				beforeSend: function (xhr) {
					/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
					xhr.setRequestHeader(header, token);
				},
			}).then(res => {
				console.log(res);
				
				//기존 디자인리스트 지우기
				$('#designBox').empty();
				$('#paging').empty();
				//페이징 지우고, 재생성
				$('#returnPaging').empty();
				
				//관심 공모전이 없을경우
				if(res.design == ''){
					alert("관심 디자인이 없습니다.");
					location.href = "/design/designList";
				}
				for (design of res.design) {
					$('#designBox').append(makeDesign(design));
				}

				$('#returnPaging').append(makePageing(res.paging)); 

			})
		} else if (!$("#love").hasClass("active")) { //하트가 눌리지 않았을 경우 실행
			location.href = "/design/designList";
		}
	}
	
	function makeDesign(data){
		console.log(data)
		let div = `
					 <div>
				        <div class="col-sm-6 col-md-4 col-lg-4" >
				            <div class="shop-item">
				                <div>
				                    <div class="stage heart active" onclick="likeCheck(this,'${data.DGN_NO}')"
				                        style="position:relative; top:90px; z-index: 1;  right: -240px;">
				                    </div>
				                    <div class="shop-item-image">
				                        <img src="/fileView/${data.CENTER_IMG}" style="width: 360px; height: 400px;" class="img-fluid">
				                        <div class="shop-item-detail">
				                            <div>
				                                <h3 class="content-box-title font-serif">[${data.CAREGORY}]${data.DGN_NO}</h3>
				                                <h3 class="content-box-title font-serif">디자이너 : ${data.USER_ID}</h3>
				                                <h3 class="content-box-title font-serif">제목: ${data.NAME}</h3>
				                            </div>
				                            <div class="btn btn-round btn-b">
				                                <a href="#" class="btn btn-round btn-b">
				                                    <span id="${data.DGN_NO}" class="icon-magnifying-glass">상세보기</span>
				                                </a>
				                            </div>
				                        </div>
				                    </div>
				                </div>
				            </div>
				        </div>
				    </div>
				  `;
	 return div;
	} 
	
	// 페이징 만들기
	function makePageing(page) {
		if (page.totalRecord == 0) {
			return;
		}
		let pagination = $("<div/>")
		let ul = $("<ul/>").attr("class","pagination");
		if (page.startPage > 1) {
			$(ul).append($("<li/>").html("&laquo;")
									.css("font-size", "30px")
									.attr("class","page-item")
									.on("click", function () {
											gopage(page.startPage - page.pageSize)
									}));
		}

		//페이지 버튼 생성.
		for (let i = page.startPage; i <= page.endPage; i++) {
			if (page.page == i) {
				$(ul).append($("<li/>") .text(i).css("font-size", "20px")
										.css("padding", "10px")
										.css("border-radius", " 10% / 50% ")
										.css("background", "#dce3fd")
										.attr("class", "page-link active")
				);
			} else {
				$(ul).append($("<li/>").text(i).css("font-size", "20px")
										.css("padding", "10px")
										.attr("class", "page-link")
										.on("click", function () {
											gopage($(this).text());
										})); //페이지이동 함수
			}
		}
		if (page.endPage < page.lastPage) {
			$(ul).append($("<li/>").html("&raquo;")
									.css("font-size", "30px")
									.attr("class","page-item")
									.on("click", function () {
											gopage(page.startPage + page.pageSize)
									}));
		}
		pagination.append(ul);
		return pagination;
	}


</script>
</div>
</html>


