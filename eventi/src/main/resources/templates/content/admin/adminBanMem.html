<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default_layout}"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<link rel="stylesheet" href="/assets/css/adminSideBar.css">
	<style>
		#admin-container {
			height: 100vh;
		}

		.footer,
		.divider-d,
		.module-small {
			margin-left: 15% !important;
		}

		#admin-contents {
			height: 100%;
			padding-left: 16%;
			padding-top: 50px;
			background: #eeeeee;
		}
	</style>
	<!-- csrf 설정 -->
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body>
	<div layout:fragment="content">
		<div id="admin-container">
			<th:block th:replace="fragments/adminPageSide :: adminSideFragment"></th:block>
			<div id="admin-contents">
				<h3>
					<b>신고회원관리</b>
				</h3>
				
				<div id="list-area">
					<div id="list-head">
						<div id="list-head-right">
							<div id="selArea">
								전체<input type="radio" name="crtfType" value="">
								사회자<input type="radio" name="crtfType" value="MC">
								디자이너<input type="radio" name="crtfType" value="DESIGNER">
								업체<input type="radio" name="crtfType" value="BUSI">
							</div>
							<div id="searchArea">
								<input type="text" name="userId">
							</div>
						</div>
					</div>
					
					<div id="table-div">
						<table id="cert-table">
							<thead>
								<tr>
									<th>요청자ID</th>
									<th>신고대상Id</th>
									<th>신고일</th>
									<th>신고종류</th>
									<th>신고사유</th>
									<th></th>
									<th></th>
								</tr>
							</thead>
							<tbody>
							
							</tbody>
						</table>
					</div>
					
					<!-- 페이징 처리 -->
					<div class="row mt-5" id="paging">
						<div class="col text-center">
							<div class="block-27" id="returnPaging"></div>
						</div>
					</div>
					
				</div>
			</div>
		</div>
		<input type="hidden" name="page" value="1">
		<script>
			var token = $("meta[name='_csrf']").attr("content");
			var header = $("meta[name='_csrf_header']").attr("content");
			ajaxList();
			
			function gopage(i) {
				let thispage = $('input[name="page"]').val(i);
				//정렬 리스트 불러오는 함수
				ajaxList(thispage);
			}
			
			$('#selArea').on('change', function () {
				$('input[name="page"]').val("1");
				ajaxList();
			});
			//비동기 통신
			function ajaxList(thispage) {
				let page = $('input[name="page"]').val();
				let banType = 'P2';
				$.ajax({
					url: "/admin/punMemAjax",
					method: 'post',
					data: {
						page,
						banType
					},
					beforeSend: function (xhr) {
						/*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
						xhr.setRequestHeader(header, token);
					},
					success: function (result) {
						//기존 tr 삭제 ->tr생성 붙여넣기
						$('tbody').empty();
						for (punish of result.punishList) {
							$('tbody').append(makeTr(punish));
						}
						//기존 페이징 삭제 -> 다시붙여넣기
						$('#returnPaging').empty();
						$('#returnPaging').append(makePaging(result.paging));
					}
				})
			}

			//tr만들기
			function makeTr(punish) {
				/* var accpDate = crtf.accpDate;
				if(!crtf.accpDate){
					accpDate = '승인대기중';
				} */
				let p = `
				<tr>
					<td>${punish.userId}</td>
					<td>${punish.targetId}</td>
					<td>${punish.dt}</td>
					<td>${punish.banType}</td>
					<td>${punish.banCntn}</td>
					<td><button type="button" onclick="updatePunMem(this, 'Y')" value="${punish.punNo}">승인</button><td>
					<td><button type="button" onclick="updatePunMem(this, 'N')" value="${punish.punNo}">거부</button><td>
				</tr>`;
				return p;
			}
			
			// 페이징 만들기
			function makePaging(page) {
				if (page.totalRecord == 0) {

					return;
				}
				let pagination = $("<div/>")
				let ul = $("<ul/>").attr("class", "pagination");
				if (page.startPage > 1) {
					$(ul).append($("<li/>").html("&laquo;")
						.css("font-size", "30px")
						.attr("class", "page-item")
						.on("click", function () {
							gopage(page.startPage - page.pageSize)
						}));
				}

				//페이지 버튼 생성.
				for (let i = page.startPage; i < page.endPage; i++) {
					if (page.page == i) {
						ul.append($("<li/>").text(i).css("font-size", "20px")
							.css("padding", "10px")
							.css("border-radius", " 10% / 50% ")
							.css("background", "#dce3fd")
							.attr("class", "page-link active")
						);
					} else {
						ul.append($("<li/>").text(i).css("font-size", "20px")
							.css("padding", "10px")
							.attr("class", "page-link")
							.on("click", function () {
								gopage($(this).text());
							})); //페이지이동 함수
					}
				}
				if (page.endPage < page.lastPage) {
					ul.append($("<li/>").html("&raquo;")
						.css("font-size", "30px")
						.attr("class", "page-item")
						.on("click", function () {
							gopage(page.startPage + page.pageSize)
						}));
				}
				pagination.append(ul);
				return pagination;
			}
			
			//승인,거부 버튼
			function updateCrtf(element, value){
				let crtfId = element.value;
				let accpYN = value;
				$.ajax({
					url:"/admin/crtfUpdate",
					method: 'post',
					data: {
						crtfId,
						accpYN
					},
					beforeSend: function (xhr) {
						xhr.setRequestHeader(header, token);
					},
					success:function(result){
						if(result>0){
							element.parentElement.parentElement.remove();
							alert("처리되었습니다.")
						}
					}
				})

			}
			
		</script>
	</div>
</body>

</html>